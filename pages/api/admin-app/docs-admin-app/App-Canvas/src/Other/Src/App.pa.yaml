# ************************************************************************************************
# Warning: YAML source code for Canvas Apps should only be used to review changes made within Power Apps Studio and for minor edits (Preview).
# Use the maker portal to create and edit your Power Apps.
# 
# The schema file for Canvas Apps is available at https://go.microsoft.com/fwlink/?linkid=2304907
# 
# For more information, visit https://go.microsoft.com/fwlink/?linkid=2292623
# ************************************************************************************************
App:
  Properties:
    BackEnabled: =false
    Formulas: "=Screen_Admin = [\n    {\n        Screen: \"Duyệt đơn hàng\",\n        Value: Screen_SO_tam\n    },\n    {\n        Screen: \"SO\",\n        Value: Main\n    },\n    {\n        Screen: \"SO báo giá\",\n        Value: 'SO_báo giá'\n    }\n];\nvar_input_gia = Switch(\n    true,\n    is_Screen_SOBG,\n    Value(txt_Gia_SOBG.Text),\n    is_Screen_SO_New,\n    Value(txt_Gia_SONew.Text),\n    Value(txt_Gia.Text)\n);\nvar_selected_khachhang = Switch(\n    true,\n    is_Screen_SOBG,\n    cb_khach_hang_SOBG.Selected,\n    is_Screen_SO_Tmp,\n    cb_khach_hang_tam.Selected,\n    is_Screen_SO,\n    cb_khach_hang.Selected,\n    is_Screen_SO_New,\n    cb_khach_hang_SO_new.Selected\n);\nvar_selected_dieukhoanthanhtoan = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_MaDH_SOBG.Selected.'Điều khoản thanh toán CAL',\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.'Điều khoản thanh toán CAL',\n    dp_MaDH.Selected.'Điều khoản thanh toán CAL'\n);\nvar_selected_VAT_SO = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_MaDH_SOBG.Selected.VAT,\n    is_Screen_SO,\n    dp_MaDH.Selected.VAT,\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.VAT\n);\nvar_selected_SO_MK = Switch(\n    true,\n    is_Screen_SO,\n    dp_MaDH.Selected.'SO mua kèm'.Id,\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.'SO mua kèm'.Id\n);\n/*var_KenhTiepNhan = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_MaDH_SOBG.Selected.'Kênh tiếp nhận SOBG',\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.'Kênh tiếp nhận',\n    dp_MaDH.Selected.'Kênh tiếp nhận'\n);*/\nvar_selected_dieukhoanthanhtoan_choice = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_MaDH_SOBG.Selected.'Điều khoản thanh toán',\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.'Điều khoản thanh toán',\n    dp_MaDH.Selected.'Điều khoản thanh toán'\n);\nvar_selected_Checkbox_duyetgia = Switch(\n    true,\n    is_Screen_SOBG,\n    Checkbox_duyetgia_SOBG.Value And dp_nhapthucong_theochietkhau_SOBG.Selected.Value = \"Theo chiết khấu\",\n    is_Screen_SO_New,\n    Checkbox_DuyetGiaSO.Checked And dp_nhapthucong_theochietkhau_SO.Selected.Value = \"Theo chiết khấu\",\n    Checkbox_duyetgia.Value And dp_nhapthucong_theochietkhau.Selected.Value = \"Theo chiết khấu\"\n);\nvar_selected_id_donhang = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_MaDH_SOBG.Selected.ID,\n    is_Screen_SO_New,\n    cb_donhang_SO_new.Selected.Id,\n    dp_MaDH.Selected.Id\n);\nvar_selected_VAT = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_VAT_SOBG.Selected.Value,\n    is_Screen_SO_New,\n    Dropdown_VAT_New.Selected.Value,\n    dp_VAT.Selected.Value\n);\nfx_GetInvoiceType = Switch(\n    true,\n    is_Screen_SOBG, \n        Text(dp_MaDH_SOBG.Selected.'Loại hóa đơn'),\n    is_Screen_SO, \n        Text(dp_MaDH.Selected.'Loại hóa đơn'), \n    is_Screen_SO_New, \n        Text(cb_donhang_SO_new.Selected.'Loại hóa đơn'),\n    Blank()\n);\nvar_selected_SP = Switch(\n    true,\n    is_Screen_SOBG,\n    cb_san_pham_SOBG.Selected,\n    is_Screen_SO_New,\n    cb_SanPham_SO_New.Selected,\n    cb_san_pham.Selected\n);\nvar_selected_manhomSP = Switch(\n    true,\n    is_Screen_SOBG,\n    cb_san_pham_SOBG.Selected.'Mã nhóm sp',\n    is_Screen_SO_New,\n    cb_SanPham_SO_New.Selected.'Mã nhóm sp',\n    cb_san_pham.Selected.'Mã nhóm sp'\n);\nvar_selected_maSP = Switch(\n    true,\n    is_Screen_SOBG,\n    cb_san_pham_SOBG.Selected.'Mã sản phẩm',\n    is_Screen_SO,\n    cb_san_pham.Selected.'Mã sản phẩm',\n    is_Screen_SO_New,\n    cb_SanPham_SO_New.Selected.'Mã sản phẩm'\n);\nvar_input_soluong = Switch(\n    true,\n    is_Screen_SOBG,\n    Value(txt_So_luong_SOBG.Text),\n    is_Screen_SO_New,\n    NumberInput_SL.Value,\n    Value(txt_So_luong.Text)\n);\nvar_selected_Promotion = Switch(\n    true,\n    is_Screen_SOBG,\n    cb_listPromotion_SOBG.Selected,\n    is_Screen_SO_New,\n    Dropdown_Promotion.Selected,\n    cb_listPromotion_SO.Selected\n);\nvar_selected_nhomgia = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_nhom_gia_SOBG.Selected,\n    is_Screen_SO_New,\n    Dropdown_NhomGia_New.Selected,\n    dp_nhom_gia.Selected\n);\nvar_selected_donvi = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_Don_vi_SOBG.Selected,\n    is_Screen_SO_New,\n    Dropdown_DVT_new.Selected,\n    dp_Don_vi.Selected\n);\nvar_selected_vitrikho = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_ViTriKho_SOBG.Selected,\n    is_Screen_SO_New,\n    Dropdown_KhoDapUngSO.Selected,\n    dp_ViTriKho.Selected\n);\nvar_selected_theochietkhau = Switch(\n    true,\n    is_Screen_SOBG,\n    dp_theochietkhau_SOBG.Selected.Value,\n    is_Screen_SO,\n    dp_theochietkhau.Selected.Value,\n    is_Screen_SO_New,\n    dp_theochietkhau_SO.Selected.Value\n);\nvar_MaKH = var_selected_khachhang.'Mã khách hàng';\nvar_Nganh_nghe = If(\n    var_selected_khachhang.'Ngành nghề text' = \"5. Shop bán lẻ\",\n    \"Shop\",\n    \"Nhà máy\"\n);\nvar_sinhnhat = Text(\n    khachhang_selected.'Ngày sinh',\n    \"mm\"\n) = Text(\n    Now(),\n    \"mm\"\n);\nvar_last_order_date = DateDiff(\n    khachhang_selected.Last_order_date,\n    Now(),\n    TimeUnit.Months\n) >= 3;\nvar_Tinh_thanh = var_selected_khachhang.'Tỉnh/thành CAL';\nvar_QuanHuyen = var_selected_khachhang.'Quận huyện CAL';\nvar_QuanHuyen_key = var_selected_khachhang.'Key quận huyện';\nvar_leadtime_tinhthanh = If(\n    !IsBlank(var_Tinh_thanh),\n    LookUp(\n        'Tỉnh/Thành',\n        'Tên Tỉnh/Thành' = var_Tinh_thanh\n    ).'Lead time - local',\n    LookUp(\n        'Tỉnh/Thành',\n        'Tên Tỉnh/Thành' = \"Bình Định\"\n    ).'Lead time - local'\n);\nvar_leadtime_quanhuyen = LookUp(\n    'Quận/Huyện',\n    Status = 'Status (Quận/Huyện)'.Active And Key_Auto = var_QuanHuyen_key\n).'Lead time theo ca';\nvar_KH_vip = LookUp(\n    'Group - KH',\n    'Mã KH' = var_MaKH And !IsBlank('VIP NhomKH') And Status = 'Status (Group - KH)'.Active\n);\nList_Product = Filter(\n    products,\n    Status = 'Status (products)'.Active,\n    !IsBlank('Tên sản phẩm')//,(var_selected_VAT_SO = VAT_choice.'Có VAT' And GTGT <> 'GTGT (products)'.'0%')\n);\nList_Customer = Sort(\n    Filter(\n        Customers,\n        Status = 'Status (Customers)'.Active,\n        'Loại đối tượng' = 'Loại đối tượng - KH'.'Khách hàng',\n        //'Local ' = \"Quy Nhơn\",\n        'Trạng thái KH' = 'Trạng thái KH (Customers)'.'Khách hàng chính thức'\n    ),\n    'Customer name'\n);\nvar_list_gia = Filter(\n    'Báo giá - chi tiếts',\n    'Đơn vị'.ID = var_selected_donvi.ID,\n    'Trạng thái hiệu lực' <> 'trạng thái hiệu lực'.'Hết hiệu lực',\n    Status = 'Status (Báo giá - chi tiếts)'.Active,\n    'Pricing deactive' = Pricing.Active\n);\nvar_list_gia_KH = Filter(\n    'Báo giá - chi tiếts',\n    'Mã KH' = var_MaKH,\n    'Đơn vị'.ID = var_selected_donvi.ID,\n    Status = 'Status (Báo giá - chi tiếts)'.Active,\n    'Trạng thái hiệu lực' <> 'trạng thái hiệu lực'.'Hết hiệu lực',\n    'Pricing deactive' = Pricing.Active\n);\nvar_duyetgiasup = Filter(\n    'Duyệt giá',\n    Status = 'Status (Duyệt giá)'.Active,\n    'Manager duyệt' = 'Manager duyệt (Duyệt giá)'.'Đã duyệt',\n    'Khách hàng'.'Mã khách hàng' = var_MaKH,\n    'Đơn vị'.ID = var_selected_donvi.ID,\n    IsBlank('Mã đơn hàng CT text')\n);\nvar_List_GR_KH = ShowColumns(\n    Filter(\n        'Group - KH',\n        'Mã KH' = var_MaKH And Status = 'Status (Group - KH)'.Active And 'Nhóm khách hàng - BGCT' = \"Yes\"\n    ),\n    'Mã nhóm KH'\n);\nVar_ton_kho_lythuyet_bomua = LookUp(\n    'Kho Bình Định',\n    'Vị trí kho'.'Tên kho' = var_selected_vitrikho.'Tên kho' && 'Tên sản phẩm'.'Mã sản phẩm' = var_selected_maSP,\n    'Tồn kho lý thuyết - Bỏ mua'\n);\nVar_ton_kho_lythuyet_inventory = LookUp(\n    'Inventory Weshops',\n    'Vị trí kho'.'Tên kho' = var_selected_vitrikho.'Tên kho' && 'Sản phẩm'.'Mã sản phẩm' = var_selected_maSP,\n    'Số lượng tồn lý thuyết'\n);\n\n\nVar_ton_kho_lythuyet_inventory_vitrikho = LookUp(\n    'Inventory Weshops',\n    'Vị trí kho'.'Tên kho' = var_selected_vitrikho.'Tên kho' && 'Sản phẩm'.'Mã sản phẩm' = var_selected_maSP,'Vị trí kho'\n);\n\nvar_ton_kho_lythuyet_KT = \nLookUp(\n    'Tồn kho kế toáns',\n    'Mã sản phẩm' = var_selected_maSP And ((var_selected_VAT_SO = VAT_choice.'Có VAT' And 'Tên thương mại text' = \"WECARE\")||(var_selected_VAT_SO = VAT_choice.'Không VAT' And fx_GetInvoiceType = \"Hộ kinh doanh\" And 'Tên thương mại text' = \"WESHOP\")),\n    'Tồn lý thuyết'\n);\nvar_list_gia_nhom = Sort(\n    AddColumns(\n        If(\n            var_Nganh_nghe = \"Nhà máy\",\n            Filter(\n                var_list_gia,\n                'Ngành nghề' = var_Nganh_nghe\n            ),\n            If(\n                CountRows(var_list_gia_KH) = 1,\n                Filter(\n                    var_list_gia_KH,\n                    'Mã KH' = var_MaKH\n                ),\n\n                Filter(\n                    'Báo giá - chi tiếts',\n                    'Đơn vị'.ID = var_selected_donvi.ID,\n                    Status = 'Status (Báo giá - chi tiếts)'.Active,\n                    'Trạng thái hiệu lực' <> 'trạng thái hiệu lực'.'Hết hiệu lực',\n                    'Pricing deactive' = Pricing.Active,\n                    ('Nhóm đối tượng'.'Mã nhóm KH' in var_List_GR_KH And CountRows(var_List_GR_KH) > 0)\n                )\n            )\n        ),\n        Gia_format,\n        Text(\n            Value(\n                Switch(\n                    true,\n                    // ✅ Que hàn đặc biệt\n\n                    var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá đã bao gồm VAT( VAT hỗ trợ)' && var_selected_VAT_SO = VAT_choice.'Có VAT',\n                    'Giá không VAT',\n                    var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá đã bao gồm VAT( VAT hỗ trợ)' && var_selected_VAT_SO = VAT_choice.'Không VAT',\n                    Giá,\n                    // ✅ Các trường hợp khác theo bản chất\n\n                    var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá đã bao gồm VAT',\n                    If(\n                        var_selected_VAT_SO = VAT_choice.'Có VAT',\n                        'Giá không VAT',\n                        Giá\n                    ),\n                    var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá chưa bao gồm VAT',\n                    'Giá không VAT',\n                    // ✅ Mặc định\n\n                    Giá\n                )\n            ),\n            \"#,###\"\n        )\n    ),\n    Gia_format,\n    SortOrder.Ascending\n);\ngia_duyet = If(\n    CountRows(var_duyetgiasup) > 0 And (Checkbox_duyetgiasup.Value || Checkbox_DuyetGiaSUPSO.Checked),\n    First(var_duyetgiasup).'Giá đáp ứng',\n    If(\n        !IsEmpty(var_list_gia_nhom),\n        var_selected_nhomgia.Gia_format\n    )\n);\nngay_giao = If(\n    var_Nganh_nghe = \"Shop\",\n    DateAdd(\n        Now(),\n        var_leadtime_quanhuyen * 12,\n        TimeUnit.Hours\n    ),\n    If(\n        var_input_soluong * var_selected_donvi.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)' > var_selected_SP.'Tồn kho lý thuyết (bỏ mua) - BD',\n        DateAdd(Today(), var_selected_SP.'Lead time'),\n        DateAdd(Today(), 1)\n    )\n);\nMax_stt = If(\n    !IsBlank(var_selected_id_donhang),\n    First(\n        Sort(\n            Filter(\n                'Sale Order Details',\n                'Mã đơn hàng'.Id = var_selected_id_donhang,\n                Status = 'Status (Sale Order Details)'.Active\n            ),\n            'Stt đơn',\n            SortOrder.Descending\n        )\n    ).'Stt đơn',\n    0\n);\n\nList_DVT = Filter(\n    'Unit conversions',\n    Status = 'Status (Unit conversions)'.Active,\n    'Mã SP' = var_selected_maSP\n);\nvar_DHSO = Sort(\n    Filter(\n        Sale_Orders,\n        'Mã khách hàng' = var_MaKH,\n        'Trạng thái giao nhận 1' = 'trạng thái giao nhận sale'.'Chưa giao',\n        Status = 'Status (Sale_Orders)'.Active,\n        'Active data' = 'Active data (Sale_Orders)'.Active\n    ),\n    'Created On',\n    SortOrder.Descending\n);\nvar_SODBG = Filter(\n    'SOD báo giá',\n    Status = 'Status (SOD báo giá)'.Active,\n    'Mã đơn hàng'.ID = dp_MaDH_SOBG.Selected.ID\n);\nvar_SOD = Filter(\n    'Sale Order Details',\n    Status = 'Status (Sale Order Details)'.Active,\n    'Mã đơn hàng'.Id = var_selected_id_donhang\n);\ngia_duyet_SOBG = If(\n    CountRows(var_duyetgiasup_SOBG) > 0 And Checkbox_duyetgiasup_SOBG.Value,\n    First(var_duyetgiasup_SOBG).'Giá đáp ứng',\n    If(\n        !IsBlank(var_selected_donvi.ID),\n        var_selected_nhomgia.Gia_format\n    )\n);\n/////////////////////////Promotion cải tiến\nListFilterPromotion = ShowColumns(\n    Filter(\n        Promotion,\n        (Coalesce(\n            var_MaKH,\n            khachhang_selected.'Mã khách hàng'\n        ) & \",\") in 'Mã khách hàng áp dụng',\n        Status = 'Status (Promotion)'.Active,\n        'Promotion Deactive' = \"Active\",\n        'Start date' <= Now()\n    ),\n    ID,\n    Promotion,\n    'Phân Loại chương trình',\n    'Lead time promotion',\n    'Chiết khấu 2',\n    'Mã sản phẩm_Multiple',\n    'Mã nhóm sp_multiple',\n    'Mã nhóm sp (Mua kèm)',\n    'Mã sản phẩm (mua kèm)',\n    'Mã khách hàng áp dụng',\n    \n    Type,\n    Status,\n    'Điều khoản thanh toán áp dụng',\n    'Mã promotion',\n    'Tổng tiền áp dụng',\n    'Cộng dồn số lượng',\n    'Promotion type (text)',\n    'Số lượng áp dụng',\n    'Số lượng áp dụng mức 3',\n    Value,\n    'Value 2',\n    'Value 3',\n    'Value mua kèm',\n    'Value có VAT','Value không VAT',\n    'VNĐ/%',\n    'Điều khoản thanh toán áp dụng mức 3',\n    'Điều khoản thanh toán áp dụng mức 2', \n    'Nhóm BG khách hàng áp dụng',\n    'Đơn vị tính','Sale hàng tồn'\n);\nvar_cong_don = Switch(\n    true,\n    is_Screen_SO,\n    Sum(\n        Filter(\n            formData,\n            PromotionRecord.'Promotion type (text)' = var_selected_Promotion.TypePromotion\n        ),\n        'Số lượng'\n    ),\n    is_Screen_SO_New,\n    Sum(\n        Filter(\n            formData_new,\n            PromotionRecord.'Promotion type (text)' = var_selected_Promotion.TypePromotion\n        ),\n        'Số lượng'\n    ),\n    Sum(\n        Filter(\n            formData_SOBG,\n            PromotionRecord.'Promotion type (text)' = var_selected_Promotion.TypePromotion\n        ),\n        'Số lượng'\n    )\n);\nListPromotion_Order = \n    Filter(\n        Sort(\n            AddColumns(\n                Filter(\n                    Filter(ListFilterPromotion, crdfd_type = \"Order\"),\n                    \n                    With(\n                        {\n                            // Tính toán helper trong mỗi record\n                            HasSPMatch: CountIf(var_table_SP, Text(Value) in crdfd_masanpham_multiple) > 0,\n                            HasNSPMatch: CountIf(var_table_NSP, Text(Value) in cr1bb_manhomsp_multiple) > 0,\n                            PaymentTerms_Concat: Concat(cr1bb_ieukhoanthanhtoanapdung, Value, \", \")\n                        },\n                        \n                        // === ĐIỀU KIỆN TỔNG HỢP ===\n                        statecode = 'Status (Promotion)'.Active &&\n                        \n                        // Chiết khấu 2\n                        (cr1bb_chietkhau2 <> 'Chiết khấu 2 (Promotion)'.Yes || (HasSPMatch || HasNSPMatch)) &&\n                        \n                        // Điều khoản thanh toán\n                        (IsBlank(PaymentTerms_Concat) || \n                         (var_dieukhoanthanhtoan in PaymentTerms_Concat && (HasSPMatch || HasNSPMatch))) &&\n                        \n                        // Điều kiện đặc biệt\n                        (crdfd_name <> \"Voucher sinh nhật\" || var_sinhnhat) &&\n                        (crdfd_name <> \"Giảm giá đặc biệt_Khách hàng 3 tháng đặt lại hàng\" || \n                         (var_last_order_date && var_check_promotion_SOD)) &&\n                        \n                        // Tổng tiền tối thiểu\n                        (IsBlank(cr1bb_tongtienapdung) || Total_Order >= cr1bb_tongtienapdung)\n                    )\n                ),\n                \n                // === THÊM CÁC CỘT ===\n                NamePromotion, crdfd_name,\n                ValuePromotion, crdfd_value,\n                VND_Percent, crdfd_vn,\n                DKTT, Concat(cr1bb_ieukhoanthanhtoanapdung, Value, \", \"),\n                Ma_SP, crdfd_masanpham_multiple,\n                Ma_NSP, cr1bb_manhomsp_multiple,\n                'Chiết khấu 2', cr1bb_chietkhau2\n            ),\n            NamePromotion,\n            SortOrder.Ascending\n        ),\n        \n        // === FILTER CUỐI CHO CHIẾT KHẤU 2 ===\n        ('Chiết khấu 2' = 'Chiết khấu 2 (Promotion)'.No || IsBlank('Chiết khấu 2')) ||\n        ('Chiết khấu 2' = 'Chiết khấu 2 (Promotion)'.Yes && var_count_notIn_Promotions > 0)\n    );\nPromotion_Order_Max = \n    With(\n        {\n            // Tính max value cho các khuyến mãi phần trăm\n            MaxPercentValue: Max(\n                Filter(\n                    ListPromotion_Order,\n                    VND_Percent = 'VNĐ/% (Promotion)'.'%'\n                ),\n                ValuePromotion\n            )\n        },\n        Filter(\n            ListPromotion_Order,\n            // Lấy tất cả VNĐ hoặc % có giá trị cao nhất\n            VND_Percent = 'VNĐ/% (Promotion)'.VNĐ ||\n            (VND_Percent = 'VNĐ/% (Promotion)'.'%' && ValuePromotion = MaxPercentValue)\n        )\n    );  \nListPromotion = Sort(\n    AddColumns(\n        With(\n            {\n                // Biến trung gian cho điều kiện khớp sản phẩm/nhóm\n                var_SP_Selected: var_selected_maSP & \",\",\n                var_NSP_Selected: var_selected_manhomSP & \",\"\n            }, \n            Filter(\n                ListFilterPromotion,\n                With(\n                    {\n                        // Điều kiện cơ bản\n                        IsActivePromotion: statecode = 'Status (Promotion)'.Active,\n                        IsValidType: crdfd_type <> \"Order\" && crdfd_type <> \"Revenue\",\n\n                        // Áp dụng DVT\n                        IsDVT:var_selected_vitrikho.'Tên kho' =Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho' &&  If((!IsBlank(cr1bb_onvitinh) && cr1bb_onvitinh.'Tên đơn vị' = var_selected_donvi.'Đơn vị chuyển đổi-Transfome'), ((var_SP_Selected in crdfd_masanpham_multiple && IsBlank(cr1bb_masanphammuakem)) || (var_NSP_Selected in cr1bb_manhomsp_multiple && IsBlank(cr1bb_manhomspmuakem)) )),\n                        \n                        // Áp dụng nhóm khách hàng\n                        IsNSPApdung: If((!IsBlank(cr1bb_Nhomkhachhangapdung.'Nhóm khách hàng') && cr1bb_Nhomkhachhangapdung.'Nhóm khách hàng' = var_selected_nhomgia.'Nhóm đối tượng text'),((var_SP_Selected in crdfd_masanpham_multiple && IsBlank(cr1bb_masanphammuakem)) || (var_NSP_Selected in cr1bb_manhomsp_multiple && IsBlank(cr1bb_manhomspmuakem)) )),\n\n                        // Điều kiện loại trừ đặc biệt\n                        IsNotExcludedGroup: Not(var_selected_manhomSP in var_selected_khachhang.'Promotion json mã nhóm SP' && crdfd_name = \"[ALL] GIẢM GIÁ NHÓM SẢN PHẨM MỚI _ V1\"),\n                        IsNotExcludedGroupMN: Not(var_selected_manhomSP in var_selected_khachhang.'Promotion json mã nhóm SP' && crdfd_name = \"[MIỀN NAM] GIẢM GIÁ NHÓM SẢN PHẨM MỚI_V1\"),\n                        // Điều kiện điều khoản thanh toán\n                        PaymentTermsMatch: IsBlank(\n                            Concat(cr1bb_ieukhoanthanhtoanapdung, Value, \", \")\n                        ) || var_selected_dieukhoanthanhtoan in Concat(\n                            cr1bb_ieukhoanthanhtoanapdung, Value, \", \"\n                        ),\n\n                        // IsHangTonKhoBD\n                        txtPromotionTonKho: crdfd_promotiontypetext,\n                        IsHangTonKhoBD:  Var_ton_kho_lythuyet_bomua > 0 && ((var_SP_Selected in crdfd_masanpham_multiple && IsBlank(cr1bb_masanphammuakem)) \n                        || (var_NSP_Selected in cr1bb_manhomsp_multiple && IsBlank(cr1bb_manhomspmuakem))),\n\n                        // === TỔNG HỢP ĐIỀU KIỆN KHỚP SẢN PHẨM (INLINE) ===\n                        ProductMatches: \n                            // 1. Áp dụng cho tất cả sản phẩm\n                            (crdfd_type = \"All product\") ||\n\n                            If(!IsBlank(cr1bb_tongtienapdung),\n                            ((var_SP_Selected in crdfd_masanpham_multiple && IsBlank(cr1bb_masanphammuakem)) || (var_NSP_Selected in cr1bb_manhomsp_multiple && IsBlank(cr1bb_manhomspmuakem))) \n                            && var_Total_Order >= cr1bb_tongtienapdung,\n                            // 2. Khớp sản phẩm trực tiếp (không mua kèm)\n                            ((var_SP_Selected in crdfd_masanpham_multiple && IsBlank(cr1bb_masanphammuakem)) ||\n                             (var_NSP_Selected in cr1bb_manhomsp_multiple && IsBlank(cr1bb_manhomspmuakem)))\n                            ) ||\n                            \n                            // 3. Khớp sản phẩm mua kèm (từ form data hiện tại)\n                            ((CountIf(List_Ma_NSP_formdata, Text(Value & \",\") in cr1bb_manhomspmuakem) > 0 && \n                              !IsBlank(cr1bb_manhomsp_multiple) && \n                              var_NSP_Selected in cr1bb_manhomsp_multiple) ||\n                             (CountIf(List_Ma_SP_formdata, Text(Value & \",\") in cr1bb_masanphammuakem) > 0 && \n                              !IsBlank(crdfd_masanpham_multiple) && \n                              var_SP_Selected in crdfd_masanpham_multiple)) ||\n                            \n                            // 4. Khớp sản phẩm mua kèm (từ SO đã có)\n                            (((CountIf(List_Ma_NSP_SOD_MK, Text(Value & \",\") in cr1bb_manhomspmuakem) > 0 && \n                               (var_NSP_Selected in cr1bb_manhomsp_multiple || var_SP_Selected in crdfd_masanpham_multiple)) ||\n                              (CountIf(List_Ma_SP_SOD_MK, Text(Value & \",\") in cr1bb_masanphammuakem) > 0 && \n                               (var_NSP_Selected in cr1bb_manhomsp_multiple || var_SP_Selected in crdfd_masanpham_multiple))) &&\n                             (IsBlank(cr1bb_tongtienapdung) || Total_order_MK >= cr1bb_tongtienapdung)),\n                        Salehangton:\n                            If(\n                                // Nếu là promotion Sale hàng tồn → cần kiểm tra tồn kho hoặc NSP đặc biệt\n                                crdfd_salehangton = 'Sale hàng tồn (Promotion)'.Yes,\n                                (\n                                    Var_ton_kho_lythuyet_inventory > 0 ||\n                                    cb_san_pham_SOBG.Selected.'Mã nhóm sp' = \"NSP-00027\" ||\n                                    cb_san_pham_SOBG.Selected.'Mã nhóm sp' = \"NSP-000872\" ||\n                                    cb_san_pham_SOBG.Selected.'Mã nhóm sp' = \"NSP-000409\" ||\n                                    cb_san_pham_SOBG.Selected.'Mã nhóm sp' = \"NSP-000474\" ||\n                                    cb_san_pham.Selected.'Mã nhóm sp' = \"NSP-00027\" ||\n                                    cb_san_pham.Selected.'Mã nhóm sp' = \"NSP-000872\" ||\n                                    cb_san_pham.Selected.'Mã nhóm sp' = \"NSP-000409\" ||\n                                    cb_san_pham.Selected.'Mã nhóm sp' = \"NSP-000474\"\n                                ),\n                                // Nếu KHÔNG phải promotion Sale hàng tồn → luôn pass\n                                true\n                            )\n                    },\n                    (If(!IsBlank(cr1bb_onvitinh),IsDVT,ProductMatches) &&\n                    If(!IsBlank(cr1bb_Nhomkhachhangapdung),IsNSPApdung,ProductMatches) &&\n                    If(txtPromotionTonKho = \"Promotion - Áp dụng cho hàng có tồn kho\", IsHangTonKhoBD, ProductMatches)\n                    && IsActivePromotion \n                    && IsValidType \n                    && PaymentTermsMatch \n                    && IsNotExcludedGroup && IsNotExcludedGroupMN )\n                    && Salehangton\n                )\n            )\n        ),\n        \n        // === THÊM CÁC CỘT TÍNH TOÁN ===\n        TypePromotion, crdfd_promotiontypetext,\n        NamePromotion, crdfd_name,\n        Cong_don_so_luong, cr1bb_congdonsoluong,\n        SL_Apdung, cr1bb_soluongapdung,\n        SL_ApDungMuc3, crdfd_soluongapdungmuc3,\n        ValuePromotion, crdfd_value,\n        Value2Promotion, cr1bb_value2,\n        Value3Promotion, crdfd_value3,\n        Value_muakem, cr3b9_valuemuakem,\n        Value_VAT, crdfd_value_co_vat,\n        Value_NonVAT, crdfd_value_khong_vat,\n        VND_Percent, crdfd_vn,\n        \n        // Tính chiết khấu với logic rõ ràng hơn\n        chietkhau,\n        With(\n            {\n                BasePrice: If(is_Screen_SOBG, gia_duyet_SOBG, gia_duyet),\n                TotalDiscount: crdfd_value + cr3b9_valuemuakem\n            },\n            If(\n                crdfd_vn = 'VNĐ/% (Promotion)'.VNĐ,\n                BasePrice - TotalDiscount,                    // Giảm số tiền cố định\n                BasePrice * (1 - TotalDiscount / 100)         // Giảm theo phần trăm\n            )\n        ),\n        \n        // Các điều khoản thanh toán\n        DKTT, Concat(cr1bb_ieukhoanthanhtoanapdung, Value, \", \"),\n        DKTT_Muc3, cr1bb_ieukhoanthanhtoanapdungmuc3,\n        DKTT_Muc2, cr3b9_dieukhoanthanhtoanapdungmuc2\n    ),\n    chietkhau,\n    SortOrder.Ascending\n);\n\nValue_Promotion = With(\n    var_selected_Promotion,\n    With(\n        {\n            SL_ApDung1: ThisRecord.cr1bb_soluongapdung,\n            SL_ApDung3: ThisRecord.SL_ApDungMuc3,\n            TT_ApDung: ThisRecord.cr1bb_tongtienapdung,\n            DKTT_M2: ThisRecord.DKTT_Muc2,\n            DKTT_M3: ThisRecord.DKTT_Muc3,\n            TongSL: If(\n                ThisRecord.Cong_don_so_luong = 'Cộng dồn số lượng (Promotion)'.Yes,\n                var_input_soluong + var_cong_don,\n                var_input_soluong\n            ),\n            Total_Order_SO: var_Total_Order,\n            Value1: ThisRecord.ValuePromotion,\n            Value2: ThisRecord.Value2Promotion,\n            Value3: ThisRecord.Value3Promotion,\n            ValueVAT:ThisRecord.Value_VAT,\n            ValueNonVAT: ThisRecord.Value_NonVAT\n        },\n        Switch(\n            true,\n            //Value VAT\n            !IsBlank(ValueVAT) && var_selected_VAT_SO = VAT_choice.'Có VAT',\n            ThisRecord.ValueVAT,\n\n            //Value NonVAT\n            !IsBlank(ValueNonVAT) && var_selected_VAT_SO = VAT_choice.'Không VAT',\n            ThisRecord.ValueNonVAT,\n\n            // Áp dụng mức 1\n            IsBlank(SL_ApDung1),\n            ThisRecord.Value1,\n\n            !IsBlank(SL_ApDung1) && TongSL < SL_ApDung1,\n            ThisRecord.Value1,\n\n            // Áp dụng mức 2\n            !IsBlank(SL_ApDung1) && TongSL >= SL_ApDung1 && (IsBlank(SL_ApDung3) || TongSL < SL_ApDung3) && (IsBlank(DKTT_M2) || DKTT_M2 = var_selected_dieukhoanthanhtoan_choice),\n            ThisRecord.Value2,\n\n            // Áp dụng mức 3\n            !IsBlank(SL_ApDung3) && TongSL >= SL_ApDung3 && (IsBlank(DKTT_M3) || DKTT_M3 = var_selected_dieukhoanthanhtoan_choice),\n            ThisRecord.Value3,\n            !IsBlank(TT_ApDung) && Total_Order_SO < TT_ApDung,\n            ThisRecord.Value1,\n            !IsBlank(TT_ApDung) && Total_Order_SO >= TT_ApDung,\n            ThisRecord.Value2,\n            // Mặc định\n\n            If(\n                DKTT_M2 = var_selected_dieukhoanthanhtoan_choice,\n                ThisRecord.Value2,\n                ThisRecord.Value1\n            )\n        )\n    )\n);\nValue_Promtion_Muakem = If(\n    !IsBlank(var_selected_Promotion.Value_muakem) && (IsBlank(var_selected_Promotion.SL_ApDungMuc3) || var_selected_Promotion.SL_ApDungMuc3 > var_input_soluong),\n    var_selected_Promotion.Value_muakem,\n    0\n);\nList_Ma_SP_formdata = Filter(\n    Split(\n        Concat(\n            ShowColumns(\n                Switch(\n                    true,\n                    is_Screen_SOBG,\n                    formData_SOBG,\n                    is_Screen_SO_New,\n                    formData_new,\n                    formData\n                ),\n                'Mã sản phẩm'\n            ),\n            'Mã sản phẩm',\n            \",\"\n        ),\n        \",\"\n    ),\n    !IsBlank(Value)\n);\nList_Ma_NSP_formdata = Filter(\n    Split(\n        Concat(\n            ShowColumns(\n                Switch(\n                    true,\n                    is_Screen_SOBG,\n                    formData_SOBG,\n                    is_Screen_SO_New,\n                    formData_new,\n                    formData\n                ),\n                'Mã nhóm SP'\n            ),\n            'Mã nhóm SP',\n            \",\"\n        ),\n        \",\"\n    ),\n    !IsBlank(Value)\n);\nTotal_order_MK = Switch(\n    true,\n    is_Screen_SO,\n    LookUp(\n        Sale_Orders,\n        Id = var_selected_SO_MK\n    ).'Tổng tiền',\n    LookUp(\n        'SO báo giá',\n        ID = dp_MaDH_SOBG.Selected.'SOBG Mua kèm'.ID\n    ).'Tổng tiền'\n);\nList_Ma_NSP_SOD_MK = Filter(\n    Split(\n        If(\n            is_Screen_SO,\n            Concat(\n                ShowColumns(\n                    Filter(\n                        'Sale Order Details',\n                        'Mã đơn hàng'.Id = var_selected_SO_MK,\n                        !IsBlank(var_selected_SO_MK),\n                        Status = 'Status (Sale Order Details)'.Active\n                    ),\n                    'Mã nhóm sp'\n                ),\n                crdfd_manhomsp,\n                \",\"\n            ),\n            Concat(\n                ShowColumns(\n                    Filter(\n                        'SOD báo giá',\n                        'Mã đơn hàng'.ID = dp_MaDH_SOBG.Selected.'SOBG Mua kèm'.ID,\n                        !IsBlank(dp_MaDH_SOBG.Selected.'SOBG Mua kèm'),\n                        Status = 'Status (SOD báo giá)'.Active\n                    ),\n                    'Mã nhóm sản phẩm'\n                ),\n                crdfd_manhomsanpham,\n                \",\"\n            )\n        ),\n        \",\"\n    ),\n    !IsBlank(Value)\n);\nList_Ma_SP_SOD_MK = Filter(\n    Split(\n        If(\n            is_Screen_SO,\n            Concat(\n                ShowColumns(\n                    Filter(\n                        'Sale Order Details',\n                        'Mã đơn hàng'.Id = var_selected_SO_MK,\n                        !IsBlank(var_selected_SO_MK),\n                        Status = 'Status (Sale Order Details)'.Active\n                    ),\n                    'Mã sản phẩm'\n                ),\n                crdfd_masanpham,\n                \",\"\n            ),\n            Concat(\n                ShowColumns(\n                    Filter(\n                        'SOD báo giá',\n                        'Mã đơn hàng'.ID = dp_MaDH_SOBG.Selected.'SOBG Mua kèm'.ID,\n                        !IsBlank(dp_MaDH_SOBG.Selected.'SOBG Mua kèm'),\n                        Status = 'Status (SOD báo giá)'.Active\n                    ),\n                    'Mã sản phẩm'\n                ),\n                crdfd_masanpham,\n                \",\"\n            )\n        ),\n        \",\"\n    ),\n    !IsBlank(Value)\n);\nvar_Total_Order = Sum(\n    Switch(\n        true,\n        is_Screen_SOBG,\n        formData_SOBG,\n        is_Screen_SO_New,\n        formData_new,\n        formData\n    ),\n    'Tổng tiền'\n) + (gia_duyet * var_input_soluong) + ((gia_duyet * var_input_soluong) * (var_selected_VAT / 100));\n////////////////////////////////////////////////SO tạm\nvar_dhSOTam = Sort(\n    Filter(\n        'Đặt hàng SOS',\n        Status = 'Status (Đặt hàng SOS)'.Active,\n        'Khách hàng'.'Mã khách hàng' = var_selected_khachhang.'Mã khách hàng',\n        'Trạng thái đơn hàng' = 'Trạng thái đơn hàng (Đặt hàng SOS)'.'Chờ xác nhận'\n    ),\n    'Created On',\n    SortOrder.Descending\n);\nVar_check_duyetgia = LookUp(\n    'Đặt hàng SOS',\n    'Mã SO' = cb_donhang_tam.Selected.Value And Status = 'Status (Đặt hàng SOS)'.Active And 'Trạng thái duyệt giá' = \"Chờ xác nhận\"\n);\nvar_selected_donhangtam = CountIf(\n    List_SO_tam,\n    SelectedSP = true\n);\n/////////////////////////////////////// SO báo giá\nvar_DHBG = Sort(\n    Filter(\n        'SO báo giá',\n        'Khách hàng'.'Mã khách hàng' = var_MaKH,\n        'Trạng thái báo giá' = 'Trạng thái báo giá (SO báo giá)'.'Đang báo giá',\n        Status = 'Status (SO báo giá)'.Active\n    ),\n    'Created On',\n    SortOrder.Descending\n);\nvar_duyetgiasup_SOBG = Filter(\n    'Duyệt giá',\n    Status = 'Status (Duyệt giá)'.Active,\n    'Manager duyệt' = 'Manager duyệt (Duyệt giá)'.'Đã duyệt',\n    'Khách hàng'.'Mã khách hàng' = var_MaKH,\n    'Đơn vị'.ID = var_selected_donvi.ID,\n    IsBlank('Mã đơn hàng CT text')\n);\nvar_leadtime_tinhthanh_SOBG = If(\n    !IsBlank(var_Tinh_thanh),\n    LookUp(\n        'Tỉnh/Thành',\n        'Tên Tỉnh/Thành' = var_Tinh_thanh\n    ).'Lead time - local',\n    LookUp(\n        'Tỉnh/Thành',\n        'Tên Tỉnh/Thành' = \"Bình Định\"\n    ).'Lead time - local'\n);\nvar_leadtime_quanhuyen_SOBG = LookUp(\n    'Quận/Huyện',\n    Status = 'Status (Quận/Huyện)'.Active And Key_Auto = var_QuanHuyen_key\n).'Lead time theo ca';\nngay_giao_SOBG = If(\n    var_Nganh_nghe = \"Shop\",\n    DateAdd(\n        Now(),\n        var_leadtime_quanhuyen * 12,\n        TimeUnit.Hours\n    ),\n    If(\n        var_input_soluong * var_selected_donvi.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)' > var_selected_SP.'Tồn kho lý thuyết (bỏ mua) - BD',\n        DateAdd(Today(), var_selected_SP.'Lead time'),\n        DateAdd(Today(), 1)\n    )\n);\nMax_stt_SOBG = First(\n    Sort(\n        Filter(\n            'SOD báo giá',\n            'Mã đơn hàng'.ID = var_selected_id_donhang,\n            Status = 'Status (SOD báo giá)'.Active\n        ),\n        'Stt đơn',\n        SortOrder.Descending\n    )\n).'Stt đơn';\nvar_MultiChoiceKho = LookUp(\n    Customers,\n    'Mã khách hàng' = var_MaKH\n);\nvar_filterkho = With(\n    {\n        danhSachPhu: ForAll(\n            var_MultiChoiceKho.'Vị trí kho phụ',\n            Text(Value)\n        )\n    },\n    Filter(\n        'Kho WECARE',\n        'Tên kho' = var_MultiChoiceKho.'Vị trí kho'.'Tên kho' || 'Tên kho' in danhSachPhu\n    )\n);\nvar_Ca = If(\n    is_Screen_SOBG,\n    If(\n        Hour(ngay_giao_SOBG) >= 0 && Hour(ngay_giao_SOBG) <= 12,\n        true,\n        false\n    ),\n    If(\n        Hour(ngay_giao) >= 0 && Hour(ngay_giao) <= 12,\n        true,\n        false\n    )\n);\nvar_MultiChoiceKho_SOBG = LookUp(\n    Customers,\n    'Mã khách hàng' = var_selected_khachhang.'Mã khách hàng'\n);\nvar_filterkho_SOBG = With(\n    {\n        danhSachPhu: ForAll(\n            var_MultiChoiceKho_SOBG.'Vị trí kho phụ',\n            Text(Value)\n        )\n    },\n    Filter(\n        'Kho WECARE',\n        'Tên kho' = var_MultiChoiceKho_SOBG.'Vị trí kho'.'Tên kho' || 'Tên kho' in danhSachPhu\n    )\n);\nvar_Ca_SOBG = If(\n    Hour(ngay_giao_SOBG) >= 0 && Hour(ngay_giao_SOBG) <= 12,\n    true,\n    false\n);\nvar_count_thiet_bi_nuoc = Switch(\n    true,\n    is_Screen_SO,\n    CountRows(\n        Filter(\n            formData As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        )\n    ),\n    is_Screen_SO_New,\n    CountRows(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        )\n    ),\n    CountRows(\n        Filter(\n            formData_SOBG As fdataSOBG,\n            fdataSOBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        )\n    )\n);\nvar_count_dien = Switch(\n    true,\n    is_Screen_SO,\n    CountRows(\n        Filter(\n            formData As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        )\n    ),\n    is_Screen_SO_New,\n    CountRows(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        )\n    ),\n    CountRows(\n        Filter(\n            formData_SOBG As fdataSOBG,\n            fdataSOBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        )\n    )\n);\nvar_count_kim_khi = Switch(\n    true,\n    is_Screen_SO,\n    CountRows(\n        Filter(\n            formData As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        )\n    ),\n    is_Screen_SO_New,\n    CountRows(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        )\n    ),\n    CountRows(\n        Filter(\n            formData_SOBG As fdataSOBG,\n            fdataSOBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        )\n    )\n);\nvar_sum_thiet_bi_nuoc = Switch(\n    true,\n    is_Screen_SO,\n    Sum(\n        Filter(\n            formData As fData,\n            fData.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        ),\n        'Tổng tiền'\n    ),\n    is_Screen_SO_New,\n    Sum(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        ),\n        'Tổng tiền'\n    ),\n    Sum(\n        Filter(\n            formData_SOBG As fDataBG,\n            fDataBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị nước\"\n        ),\n        'Tổng tiền'\n    )\n);\nvar_sum_thiet_bi_dien = Switch(\n    true,\n    is_Screen_SO,\n    Sum(\n        Filter(\n            formData As fData,\n            fData.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        ),\n        'Tổng tiền'\n    ),\n    is_Screen_SO_New,\n    Sum(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        ),\n        'Tổng tiền'\n    ),\n    Sum(\n        Filter(\n            formData_SOBG As fDataBG,\n            fDataBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Thiết bị điện\"\n        ),\n        'Tổng tiền'\n    )\n);\nvar_sum_kim_khi = Switch(\n    true,\n    is_Screen_SO,\n    Sum(\n        Filter(\n            formData As fData,\n            fData.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        ),\n        'Tổng tiền'\n    ),\n    is_Screen_SO_New,\n    Sum(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        ),\n        'Tổng tiền'\n    ),\n    Sum(\n        Filter(\n            formData_SOBG As fDataBG,\n            fDataBG.'Record sản phẩm'.'Cấp 2 NHSP' = \"Vật tư kim khí\"\n        ),\n        'Tổng tiền'\n    )\n);\nvar_sum_ong_cung = Switch(\n    true,\n    is_Screen_SO,\n    Sum(\n        Filter(\n            formData As fData,\n            fData.'Record sản phẩm'.'Cấp 4' = \"Ống cứng PVC\"\n        ),\n        'Tổng tiền'\n    ),\n    is_Screen_SO_New,\n    Sum(\n        Filter(\n            formData_new As fdata,\n            fdata.'Record sản phẩm'.'Cấp 2 NHSP' = \"Ống cứng PVC\"\n        ),\n        'Tổng tiền'\n    ),\n    Sum(\n        Filter(\n            formData_SOBG As fDataBG,\n            fDataBG.'Record sản phẩm'.'Cấp 4' = \"Ống cứng PVC\"\n        ),\n        'Tổng tiền'\n    )\n);\nvar_table_supduyet = [\n    \"Bùi Tuấn Dũng\",\n    \"Lê Sinh Thông\",\n    \"Lê Thị Ngọc Anh\",\n    \"Nguyễn Quốc Chinh\",\n    \"Phạm Quốc Hưng\",\n    \"Huỳnh Minh Trung\",\n    \"Bùi Thị Mỹ Trang\",\n    \"Hà Bông\",\n    \"Vũ Thành Minh\",\n    \"Phạm Thị Mỹ Hương\",\n    \"La Hoài Phương\",\n    \"Trần Thái Huy\",\n    \"Phạm Thị Ngọc Nữ\",\n    \"Trần Thanh Phong\",\n    \"Nguyễn Quốc Hào\",\n    \"Đỗ Nguyễn Hoàng Nhân\",\n    \"Hoàng Thị Mỹ Linh\"\n];\nvar_table_duyetgia = Table(\n    {\n        Name: \"Bùi Tuấn Dũng\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Bùi Tuấn Dũng'\n    },\n    {\n        Name: \"Lê Sinh Thông\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Lê Sinh Thông'\n    },\n    {\n        Name: \"Lê Thị Ngọc Anh\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Lê Thị Ngọc Anh'\n    },\n    {\n        Name: \"Nguyễn Quốc Chinh\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Nguyễn Quốc Chinh'\n    },\n    {\n        Name: \"Phạm Quốc Hưng\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Phạm Quốc Hưng'\n    },\n    {\n        Name: \"Huỳnh Minh Trung\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Huỳnh Minh Trung'\n    },\n    {\n        Name: \"Bùi Thị Mỹ Trang\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Bùi Thị Mỹ Trang'\n    },\n    {\n        Name: \"Hà Bông\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Hà Bông'\n    },\n    {\n        Name: \"Vũ Thành Minh\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Vũ Thành Minh'\n    },\n    {\n        Name: \"Phạm Thị Mỹ Hương\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Phạm Thị Mỹ Hương'\n    },\n    {\n        Name: \"La Hoài Phương\",\n        Value: 'Duyệt giá (Sale Order Details)'.'La Hoài Phương'\n    },\n    {\n        Name: \"Trần Thái Huy\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Trần Thái Huy'\n    },\n    {\n        Name: \"Phạm Thị Ngọc Nữ\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Phạm Thị Ngọc Nữ'\n    },\n    {\n        Name: \"Trần Thanh Phong\",\n        Value: 'Duyệt giá (Sale Order Details)'.'Trần Thanh Phong'\n    }\n);\nvar_table_duyetgia_SOBG = Table(\n    {\n        Name: \"Bùi Tuấn Dũng\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Bùi Tuấn Dũng'\n    },\n    {\n        Name: \"Lê Sinh Thông\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Lê Sinh Thông'\n    },\n    {\n        Name: \"Lê Thị Ngọc Anh\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Lê Thị Ngọc Anh'\n    },\n    {\n        Name: \"Nguyễn Quốc Chinh\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Nguyễn Quốc Chinh'\n    },\n    {\n        Name: \"Phạm Quốc Hưng\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Phạm Quốc Hưng'\n    },\n    {\n        Name: \"Huỳnh Minh Trung\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Huỳnh Minh Trung'\n    },\n    {\n        Name: \"Bùi Thị Mỹ Trang\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Bùi Thị Mỹ Trang'\n    },\n    {\n        Name: \"Hà Bông\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Hà Bông'\n    },\n    {\n        Name: \"Vũ Thành Minh\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Vũ Thành Minh'\n    },\n    {\n        Name: \"Phạm Thị Mỹ Hương\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Phạm Thị Mỹ Hương'\n    },\n    {\n        Name: \"La Hoài Phương\",\n        Value: 'Duyệt giá (SOD báo giá)'.'La Hoài Phương'\n    },\n    {\n        Name: \"Trần Thái Huy\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Trần Thái Huy'\n    },\n    {\n        Name: \"Phạm Thị Ngọc Nữ\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Phạm Thị Ngọc Nữ'\n    },\n    {\n        Name: \"Trần Thanh Phong\",\n        Value: 'Duyệt giá (SOD báo giá)'.'Trần Thanh Phong'\n    }\n);\n\nvar_warning_gia = With(\n    {\n        record_Giamuadaidien: LookUp( \n            Margins,\n            'Sản phẩm'.'Mã sản phẩm' = var_selected_maSP\n        ).'Giá mua đại diện',\n        value_giatrichuyendoi: var_selected_donvi.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)'\n    },\n    If(\n        var_Nganh_nghe = \"Shop\",\n            If( \n                record_Giamuadaidien > 0,\n                If(\n                    !IsBlank(var_input_gia) && (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien < 0.1,\n                    {\n                        value: true,\n                        Label: \"Giá lỗ 90%\",\n                        Giá: (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien\n                    },\n                    If(\n                        !IsBlank(var_input_gia) && (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien >= 2.6,\n                        {\n                            value: true,\n                            Label: \"Giá vượt 100%\",\n                            Giá: (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien\n                        },\n                        {\n                            value: false,\n                            Label: \"Giá bình thường\",\n                            Giá: (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien\n                        }\n                    )\n                ),\n                {\n                    value: false,\n                    Label: \"Giá bình thường\",\n                    Giá: (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien\n                }\n            ),\n        {\n            value: false,\n            Label: \"Giá bình thường\",\n            Giá: (var_input_gia / value_giatrichuyendoi) / record_Giamuadaidien\n        }\n    )\n);\nvar_choice_nhapthucong_theochietkhau = If(\n    (var_Nganh_nghe = \"Shop\" And var_selected_nhomgia.'Nhóm đối tượng text' = \"Shop\") Or var_selected_nhomgia.'Nhóm đối tượng text' = \"Miền Nam\" , \n    [\n        \"Nhập thủ công\",\n        \"Theo chiết khấu\"\n    ],\n    [\"Nhập thủ công\"]\n);\nvar_choice_theochietkhau = [\n    \"1\",\n    \"2\",\n    \"3\",\n    \"4\",\n    \"5\",\n    \"6\",\n    \"7\",\n    \"8\",\n    \"9\",\n    \"10\",\n    \"20\"\n];\ngia_theochietkhau = var_selected_nhomgia.Gia_format - (var_selected_nhomgia.Gia_format * var_selected_theochietkhau / 100);\nLk_donhangtam = LookUp(\n    var_dhSOTam,\n    'Mã SO' = cb_donhang_tam.Selected.Value\n);\n"
    StartScreen: =Main
    Theme: =GreenTheme
