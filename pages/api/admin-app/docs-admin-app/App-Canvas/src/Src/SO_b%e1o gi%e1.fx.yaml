"'SO_báo giá' As screen":
    Fill: =RGBA(237, 237, 237, 1)
    LoadingSpinnerColor: =App.Theme.Colors.Primary
    OnHidden: =Set(is_Screen_SOBG,false);
    OnVisible: |
        =Set(is_Screen_SOBG,true);
        UpdateContext({reset_control: true});
        Reset(cb_san_pham_SOBG);
        Reset(dp_Don_vi_SOBG);
        Reset(txt_So_luong_SOBG);
        Reset(txt_Gia_SOBG);
        Reset(dp_VAT_SOBG);
        Reset(dp_ngay_giao_SOBG);
        Reset(dp_ngay_giao_NM_SOBG);
        Reset(cb_khach_hang_SOBG);
        Reset(dp_MaDH_SOBG);

    Rectangle1_2 As rectangle:
        BorderColor: =App.Theme.Colors.Darker40
        Fill: =RGBA(255, 255, 255, 1)
        Height: =10
        Width: =1366
        Y: =81
        ZIndex: =6

    Rectangle1_3 As rectangle:
        BorderColor: =App.Theme.Colors.Darker40
        Fill: =RGBA(255, 255, 255, 1)
        Height: =5
        Width: =1366
        Y: =195
        ZIndex: =32

    NgaygiaoNM_SOBG As label:
        BorderColor: =App.Theme.Colors.Darker40
        Color: =RGBA(77, 77, 77, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Font: =Font.Arial
        Height: =30
        Size: =11
        Text: ="Ngày giao NM"
        Visible: =!IsBlank(cb_khach_hang_SOBG.SelectedItems) And var_Nganh_nghe = "Nhà máy"
        Width: =110
        X: =11
        Y: =217
        ZIndex: =33

    dp_ngay_giao_NM_SOBG As datepicker:
        BorderColor: =RGBA(237, 237, 237, 1)
        BorderThickness: =1
        CalendarHeaderFill: =App.Theme.Colors.Primary
        Color: =RGBA(0, 0, 0, 1)
        DefaultDate: =ngay_giao
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Font: =App.Theme.Font
        Format: ="dd/mm/yyyy"
        Height: =30
        HoverDateFill: =App.Theme.Colors.Lighter70
        IconBackground: =App.Theme.Colors.Primary
        OnChange: |-
            =If(
                dp_ngay_giao_NM_SOBG.SelectedDate < Max(formData_SOBG, 'Ngày giao NM') ||
                (
                    dp_ngay_giao_NM_SOBG.SelectedDate = Today() &&
                    Hour(Now()) >= 15
                ),
                Notify(
                    "Ngày giao dự kiến không hợp lệ",
                    NotificationType.Warning,
                    1000
                );
                Reset(dp_ngay_giao_NM_SOBG)
            )
        PaddingBottom: =0
        PaddingLeft: =5
        SelectedDateFill: =App.Theme.Colors.Primary
        Size: =11
        Visible: =!IsBlank(cb_khach_hang_SOBG.SelectedItems) And var_Nganh_nghe = "Nhà máy"
        Width: =120
        X: =120
        Y: =211
        ZIndex: =34

    Data_don_chi_tiet_SOBG As dataTable.datatable:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderStyle: =BorderStyle.Solid
        BorderThickness: =1
        Color: =RGBA(77, 77, 77, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisplayMode: =DisplayMode.Edit
        Fill: =RGBA(255, 255, 255, 1)
        Font: =Font.Arial
        FontWeight: =FontWeight.Normal
        HeadingColor: =RGBA(255, 255, 255, 1)
        HeadingFill: =RGBA(4, 161, 179, 1)
        HeadingFont: =Font.Arial
        HeadingFontWeight: =FontWeight.Bold
        HeadingSize: =12
        Height: =515
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =RGBA(204, 231, 246, 1)
        InputFill: =RGBA(255, 255, 255, 1)
        InvertedColor: =RGBA(255, 255, 255, 1)
        Items: =Sort(formData_SOBG, STT, SortOrder.Descending)
        LinkColor: =App.Theme.Colors.Lighter10
        NoDataText: ="Chưa có đơn hàng"
        PrimaryColor1: =App.Theme.Colors.Primary
        PrimaryColor2: =App.Theme.Colors.Darker30
        PrimaryColor3: =App.Theme.Colors.Lighter70
        SelectedColor: =RGBA(0, 0, 0, 1)
        SelectedFill: =App.Theme.Colors.Lighter70
        Size: =11
        Visible: =true
        Width: =1366
        X: =0
        Y: =253
        ZIndex: =42

        STT_Column1_1 As dataTableColumn.textualColumn:
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="STT"
            FieldName: ="STT"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =10
            Text: =ThisItem.STT
            Width: =50
            X: =0
            Y: =0
            ZIndex: =38

        "'Tên sản phẩm_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Tên sản phẩm"
            FieldName: ="Tên sản phẩm"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            IsHyperlink: =false
            LayoutHeight: =Parent.Height
            Order: =14
            Text: =ThisItem.'Tên sản phẩm'
            Visible: =true
            Width: =207
            X: =0
            Y: =0
            ZIndex: =39

        "'Đơn vị_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Đơn vị"
            FieldName: ="Đơn vị"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =19
            Text: =ThisItem.'Đơn vị'
            Width: =104
            X: =0
            Y: =0
            ZIndex: =40

        "'Số lượng_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Số lượng"
            FieldName: ="Số lượng"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =22
            Text: |
                =Text(ThisItem.'Số lượng', "#,###.##")
            Width: =118
            X: =0
            Y: =0
            ZIndex: =41

        Giá_Column1_1 As dataTableColumn.textualColumn:
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Giá"
            FieldName: ="Giá"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =28
            Text: |-
                =Text(ThisItem.Giá, "#,###")
            Width: =92
            X: =0
            Y: =0
            ZIndex: =42

        "'Giá đã giảm_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Giá đã CK"
            FieldName: ="Giá đã giảm"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =42
            Text: |-
                =Text(ThisItem.'Giá đã giảm', "#,###.##")
            Visible: =If(cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,true,false)
            Width: =125
            X: =0
            Y: =0
            ZIndex: =43

        VAT_Column1_1 As dataTableColumn.textualColumn:
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="VAT"
            FieldName: ="VAT"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =43
            Text: =ThisItem.VAT
            Width: =55
            X: =0
            Y: =0
            ZIndex: =44

        "'Tổng tiền_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Tổng tiền"
            FieldName: ="Tổng tiền"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =44
            Text: |-
                =Text(ThisItem.'Tổng tiền', "#,###")
            Width: =110
            X: =0
            Y: =0
            ZIndex: =46

        "'Ngày giao_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Ngày giao"
            FieldName: ="Ngày giao"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =46
            Text: =If(var_Nganh_nghe = "Shop", Text(ThisItem.'Ngày giao',"dd/mm/yyyy"),Text(ThisItem.'Ngày giao NM',"dd/mm/yyyy"))
            Visible: =true
            Width: =139
            X: =1119
            Y: =0
            ZIndex: =48

        "'% Giảm giá_Column1_1' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Chiết khấu"
            FieldName: ="% Giảm giá"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =40
            Text: =ThisItem.'% Giảm giá'
            Visible: =If(cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,true,false)
            Width: =110
            X: =0
            Y: =0
            ZIndex: =49

        "'ID đơn hàng_Column3' As dataTableColumn.textualColumn":
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: =
            FieldName: ="ID đơn hàng"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =49
            Text: =If(IsBlank(ThisItem.'ID đơn hàng'),"","✅")
            Width: =56
            X: =0
            Y: =0
            ZIndex: =51

        duyet_gia_Column2 As dataTableColumn.textualColumn:
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Người duyệt"
            FieldName: ="duyet_gia"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =45
            Text: =ThisItem.duyet_gia
            Width: =136
            X: =0
            Y: =0
            ZIndex: =52

        Ca_Column2 As dataTableColumn.textualColumn:
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Ca"
            FieldName: ="Ca"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =47
            Text: =ThisItem.Ca
            Width: =100
            X: =0
            Y: =0
            ZIndex: =53

        phuphihoadon As dataTableColumn.textualColumn:
            AutoWidth: =false
            DisplayMode: =DisplayMode.Edit
            FieldDisplayName: ="Phụ phí hóa đơn"
            FieldName: ="Chietkhauphantram"
            FieldVariantName: ="textualColumn"
            Height: =Parent.Height
            LayoutHeight: =Parent.Height
            Order: =32
            Text: =ThisItem.'Phụ phí hoá đơn'
            Visible: |-
                =If(
                    dp_MaDH_SOBG.Selected.'Loại hóa đơn' = 'Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' And dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT' And var_Nganh_nghe = "Shop",
                    true,
                    false
                )
            Width: =94
            X: =0
            Y: =0
            ZIndex: =54

    Label8_1 As label:
        Align: =Align.Right
        BorderColor: =App.Theme.Colors.Darker40
        Color: =RGBA(0, 0, 0, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Font: =App.Theme.Font
        Height: =30
        Size: =13
        Text: ="V2.82"
        Width: =88
        X: =1278
        ZIndex: =44

    cb_listPromotion_SOBG As combobox:
        BorderColor: =RGBA(202, 202, 202, 1)
        ChevronBackground: =RGBA(255, 255, 255, 1)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =RGBA(255, 255, 255, 1)
        Color: =RGBA(77, 77, 77, 1)
        DefaultSelectedItems: =If( !IsBlank(cb_san_pham_SOBG.SelectedItems) And !IsBlank(txt_Gia_SOBG.Text) And !Checkbox_duyetgia_SOBG.Value And !Checkbox_duyetgiasup_SOBG.Value And ( dp_nhom_gia_SOBG.Selected.'Loại bỏ Promotion' = "No" Or dp_nhom_gia_SOBG.Selected.'Nhóm đối tượng text' = "Miền Nam"), First(ListPromotion), Blank() )
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        DisplayFields: =["NamePromotion"]
        Font: =Font.Arial
        Height: =35
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        InputTextPlaceholder: ="Khuyễn mãi"
        Items: =ListPromotion
        OnChange: =
        PressedColor: =RGBA(116, 116, 116, 1)
        PressedFill: =App.Theme.Colors.Darker30
        SearchFields: =["NamePromotion"]
        SearchItems: =Search(ListPromotion,cb_listPromotion_SOBG.SearchText,NamePromotion)
        SelectionFill: =App.Theme.Colors.Primary
        SelectMultiple: =false
        Size: =12
        Visible: =!IsBlank(cb_san_pham_SOBG.SelectedItems) And !IsBlank(txt_Gia_SOBG.Text) And !Checkbox_duyetgia_SOBG.Value And !Checkbox_duyetgiasup_SOBG.Value And (dp_nhom_gia_SOBG.Selected.'Loại bỏ Promotion' = "No" Or dp_nhom_gia_SOBG.Selected.'Nhóm đối tượng text' = "Miền Nam")
        Width: =350
        X: =614
        Y: =158
        ZIndex: =45

    dp_ViTriKho_SOBG As dropdown:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderThickness: =1
        ChevronBackground: =RGBA(0, 0, 0, 0)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =RGBA(255, 255, 255, 1)
        Color: =RGBA(77, 77, 77, 1)
        Default: =var_MultiChoiceKho_SOBG.'Vị trí kho'.'Tên kho'
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        DisplayMode: =If(IsBlank(dp_MaDH_SOBG.Selected), DisplayMode.Disabled, DisplayMode.Edit)
        Font: =Font.Arial
        Height: =28
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        Items: =var_filterkho_SOBG
        PressedColor: =RGBA(255, 255, 255, 1)
        PressedFill: =App.Theme.Colors.Darker30
        Reset: =
        SelectionFill: =App.Theme.Colors.Primary
        Size: =12
        Visible: =cb_khach_hang_SOBG.Selected.'Ngành nghề text' = "5. Shop bán lẻ"
        Width: =164
        X: =10
        Y: =161
        ZIndex: =48

    Group3_1 As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =48

        Icon_Luu_SOBG As icon.Save:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(8, 122, 135, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(244, 244, 244, 1)
            Height: =40
            Icon: =Icon.Save
            OnSelect: |+
                =UpdateContext({lookup_donhang_SOBG: dp_MaDH_SOBG.Selected});
                
                    // ============ KIỂM TRA TỒN KHO CHO ĐƠN HÀNG KHÔNG VAT (KHO BÌNH ĐỊNH) ============
                    // Chỉ kiểm tra các dòng mới chưa có ID đơn hàng (ID đơn hàng)
                
                    Set(
                
                        Var_SP_thieu_ton_SOBG,
                
                        If(
                
                            loai_don_SOBG.Text = "Không VAT" 
                
                                && dp_ViTriKho_SOBG.Selected.'Tên kho' = Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho',
                
                            First(
                
                                Filter(
                
                                    formData_SOBG As item,
                
                                    // Chỉ kiểm tra các dòng chưa có ID đơn hàng (dòng mới)
                                    IsBlank(item[@'ID đơn hàng']) &&
                
                                    item.'Mã nhóm SP' <> "NSP-00027" &&
                
                                    item.'Mã nhóm SP' <> "NSP-000872" &&
                                    item.'Mã nhóm SP' <> "NSP-000409" &&
                                    item.'Mã nhóm SP' <> "NSP-000474" &&
                
                                    With(
                
                                        {
                
                                            ton_kho_inventory: LookUp(
                
                                                'Inventory Weshops',
                
                                                'Mã sản phẩm' = item.'Mã sản phẩm',
                
                                                'Số lượng tồn lý thuyết'
                
                                            )
                
                                        },
                
                                        Value(item[@'Số lượng']) > Coalesce(ton_kho_inventory, 0)
                
                                    )
                
                                )
                
                            ),
                
                            Blank()
                
                        )
                
                    );
                
                    // ============ XỬ LÝ KẾT QUẢ KIỂM TRA ============
                
                    If(
                
                        !IsBlank(Var_SP_thieu_ton_SOBG),
                
                        Notify(
                
                            "Không đủ tồn kho! SP: " & Var_SP_thieu_ton_SOBG.'Tên sản phẩm' &
                
                            " | Tồn còn: " &
                
                            Text(
                
                                Coalesce(
                
                                    LookUp(
                
                                        'Inventory Weshops',
                
                                        'Mã sản phẩm' = Var_SP_thieu_ton_SOBG.'Mã sản phẩm' And 'Vị trí kho'.'Tên kho' = dp_ViTriKho_SOBG.Selected.'Tên kho',
                
                                        'Số lượng tồn lý thuyết'
                
                                    ),
                
                                    0
                
                                )
                
                        ) & " " &
                
                        Coalesce(
                
                            Var_SP_thieu_ton_SOBG.'Đơn vị',
                
                            Var_SP_thieu_ton_SOBG.'Record Đơn vị'.'Đơn vị chuẩn',
                
                            ""
                
                        ),
                
                            NotificationType.Error,
                
                            5000
                
                        );
                
                        UpdateContext({showLoading: false}),
                
                        
                
                        // ============ CODE GỐC - CHỈ CHẠY KHI ĐỦ TỒN KHO ============
                
                        If(
                
                            false,//(IsBlank(var_KenhTiepNhan) And !var_kenhtiepnhan_isSelected) && var_selected_khachhang.'Ngành nghề text' = "5. Shop bán lẻ" ,
                
                            UpdateContext({show_popup_nhacchonkenhtiepnhan: true}),
                
                            Set(
                
                                khachhang_selected,
                
                                cb_khach_hang_SOBG.Selected
                
                            );
                
                            Set(
                
                                var_check_promotion_SOD,
                
                                IsEmpty(
                
                                    Filter(
                
                                        formData_SOBG,
                
                                        !IsBlank(PromotionRecord)
                
                                    )
                
                                )
                
                            );
                
                            If(
                
                                dp_ViTriKho_SOBG.DisplayMode = DisplayMode.Edit,
                
                                Patch(
                
                                    'SO báo giá',
                
                                    LookUp(
                
                                        'SO báo giá',
                
                                        'Mã đơn hàng' = dp_MaDH_SOBG.Selected.'Mã đơn hàng'
                
                                    ),
                
                                    {'Vị trí kho': dp_ViTriKho_SOBG.Selected}
                
                                )
                
                            );
                
                            If(
                
                                CountRows(formData_SOBG) > 0,
                
                                ForAll(
                
                                    formData_SOBG,
                
                                    With(
                
                                        {
                
                                            existingRecord: LookUp(
                
                                                'SOD báo giá',
                
                                                ID = formData_SOBG[@'ID đơn hàng']
                
                                            ),
                
                                            expectedDeliveryDate: If(
                
                                                cb_khach_hang_SOBG.Selected.'Ngành nghề text' = "5. Shop bán lẻ",
                
                                                formData_SOBG[@'Ngày giao'],
                
                                                formData_SOBG[@'Ngày giao NM']
                
                                            ),
                
                                            approvedPriceSUP: If(
                
                                                !IsBlank(formData_SOBG[@id_duyetgiaSUP]),
                
                                                LookUp(
                
                                                    'Duyệt giá',
                
                                                    Status = 'Status (Duyệt giá)'.Active And ID = formData_SOBG[@id_duyetgiaSUP]
                
                                                )
                
                                            ),
                
                                            mappedVAT: LookUp(
                
                                                Table(
                
                                                    {
                
                                                        VAT: 10,
                
                                                        Value: 'Thuế GTGT'.'10%'
                
                                                    },
                
                                                    {
                
                                                        VAT: 8,
                
                                                        Value: 'Thuế GTGT'.'8%'
                
                                                    },
                
                                                    {
                
                                                        VAT: 0,
                
                                                        Value: 'Thuế GTGT'.'0%'
                
                                                    }
                
                                                ),
                
                                                VAT = formData_SOBG[@VAT],
                
                                                Value
                
                                            ),
                
                                            mappedApproval: LookUp(
                
                                                var_table_duyetgia_SOBG,
                
                                                Name = formData_SOBG[@duyet_gia],
                
                                                Value
                
                                            )
                
                                        },
                
                                        Patch(
                
                                            'SOD báo giá',
                
                                            Coalesce(
                
                                                existingRecord,
                
                                                Defaults('SOD báo giá')
                
                                            ),
                
                                            {
                
                                                'Stt đơn': formData_SOBG[@STT],
                
                                                'Mã đơn hàng': lookup_donhang_SOBG,
                
                                                'Sản phẩm': formData_SOBG[@'Record sản phẩm'],
                
                                                'Đơn vị': formData_SOBG[@'Record Đơn vị'],
                
                                                'Số lượng': Value(formData_SOBG[@'Số lượng']),
                
                                                'Đơn giá': If(
                
                                                    var_Nganh_nghe = "Shop",
                
                                                    Value(formData_SOBG[@'Giá đã giảm']),
                
                                                    Value(formData_SOBG[@Giá])
                
                                                ),
                
                                                'Giá gốc': Value(formData_SOBG[@Giá]),
                
                                                'Ngày giao dự kiến': expectedDeliveryDate,
                
                                                'Điều chỉnh GTGT': mappedVAT,
                
                                                'Ghi chú': formData_SOBG[@GhiChu],
                
                                                'Duyệt giá': mappedApproval,
                
                                                'Chiết khấu %': formData_SOBG[@Chietkhauphantram],
                
                                                'Chiết khấu VNĐ': formData_SOBG[@Chietkhautien],
                
                                                'Promotion text': formData_SOBG[@promotiontext],
                
                                                Promotion: formData_SOBG[@PromotionRecord],
                
                                                'Duyệt giá sup': approvedPriceSUP,
                
                                                'Chiết khấu 2 (%)': 0,
                
                                                Ca: If(
                
                                                    formData_SOBG[@Ca] = "Ca sáng",
                
                                                    'Ca (SOD báo giá)'.'Ca sáng',
                
                                                    'Ca (SOD báo giá)'.'Ca chiều'
                
                                                ),
                
                                                'Phụ phí hoá đơn (%)': formData_SOBG[@'Phụ phí hoá đơn']
                
                                            }
                
                                        )
                
                                    )
                
                                );
                
                                Patch(
                
                                    'SO báo giá',
                
                                    lookup_donhang_SOBG,
                
                                    {
                
                                        'Số đơn chi tiết có Promotion': CountRows(
                
                                            Filter(
                
                                                formData_SOBG,
                
                                                !IsBlank(PromotionRecord) And "Thanh toán sau khi nhận hàng" in DKTT
                
                                            )
                
                                        )
                
                                    }
                
                                );
                
                                If(
                
                                    var_Nganh_nghe = "Shop" &&
                
                                    CountRows(
                
                                        Filter(
                
                                            formData_SOBG,
                
                                            'Record sản phẩm'.'Cấp 4' = "Dây điện" Or 'Record sản phẩm'.'Cấp 4' = "Cáp điện"
                
                                        )
                
                                    ) > 0,
                
                                    Patch(
                
                                        'SO báo giá',
                
                                        lookup_donhang_SOBG,
                
                                        { 'Hình thức giao hàng': HT_giaohang.'Giao 1 lần' }
                
                                    )
                
                                );
                
                                /*Patch(
                
                                    'SO báo giá',
                
                                    lookup_donhang_SOBG,
                
                                    {'Kênh tiếp nhận SOBG': dp_kenhtiepnhan_SOBG.Selected.Value}
                
                                );*/
                
                                Notify(
                
                                    "Tạo đơn bán chi tiết thành công!",
                
                                    NotificationType.Success,
                
                                    2000
                
                                );
                
                                Set(
                
                                    Total_Order,
                
                                    Sum(
                
                                        formData_SOBG,
                
                                        'Tổng tiền'
                
                                    )
                
                                );
                
                                Set(
                
                                    var_table_SP,
                
                                    Split(
                
                                        Concat(
                
                                            ShowColumns(
                
                                                formData_SOBG,
                
                                                'Mã sản phẩm'
                
                                            ),
                
                                            'Mã sản phẩm',
                
                                            ","
                
                                        ),
                
                                        ","
                
                                    )
                
                                );
                
                                Set(
                
                                    var_table_NSP,
                
                                    Split(
                
                                        Concat(
                
                                            ShowColumns(
                
                                                formData_SOBG,
                
                                                'Mã nhóm SP'
                
                                            ),
                
                                            'Mã nhóm SP',
                
                                            ","
                
                                        ),
                
                                        ","
                
                                    )
                
                                );
                
                                Set(
                
                                    var_count_notIn_Promotions,
                
                                    CountRows(
                
                                        Filter(
                
                                            formData_SOBG As item,
                
                                            CountRows(
                
                                                Filter(
                
                                                    ListPromotion_Order As PromotionM,
                
                                                    PromotionM.'Chiết khấu 2' = 'Chiết khấu 2 (Promotion)'.Yes && (item.'Mã sản phẩm' in PromotionM.Ma_SP || item.'Mã nhóm SP' in PromotionM.Ma_NSP)
                
                                                )
                
                                            ) = 0
                
                                        )
                
                                    )
                
                                );
                
                                Set(
                
                                    var_dieukhoanthanhtoan,
                
                                    dp_MaDH_SOBG.Selected.'Điều khoản thanh toán CAL'
                
                                );
                
                                UpdateContext({showLoading: false});
                
                                UpdateContext({Popup_PromotionOrder: true});
                
                                Reset(cb_san_pham_SOBG);
                
                                Reset(dp_Don_vi_SOBG);
                
                                Reset(txt_So_luong_SOBG);
                
                                Reset(txt_Gia_SOBG);
                
                                Reset(dp_VAT_SOBG);
                
                                Clear(formData_SOBG);
                
                                Reset(cb_khach_hang_SOBG);
                
                                Reset(dp_MaDH_SOBG);
                
                                Reset(dp_ngay_giao_NM_SOBG);
                
                                Reset(txt_Ghichu_SOBG);
                
                                Reset(dp_ngay_giao_SOBG);
                
                                Reset(dp_ViTriKho_SOBG);
                
                                Reset(dp_Ca_SOBG),
                
                                Notify(
                
                                    "Không có data để tạo đơn báo giá chi tiết !!",
                
                                    NotificationType.Error,
                
                                    2000
                
                                )
                
                            )
                
                        )
                
                    )
                
            Width: =40
            X: =1226
            Y: =213
            ZIndex: =35

        Icon_Reset_SOBG As icon.Save:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(8, 122, 135, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(244, 244, 244, 1)
            Height: =40
            Icon: =Icon.Reload
            OnSelect: |-
                =//Reset(dp_MaDH_SOBG);
                Reset(cb_san_pham_SOBG);
                Reset(dp_Don_vi_SOBG);
                Reset(txt_So_luong_SOBG);
                Reset(txt_Gia_SOBG);
                Reset(dp_VAT_SOBG);
                Reset(dp_ngay_giao_SOBG);
                Reset(dp_ngay_giao_NM_SOBG);
                Reset(cb_khach_hang_SOBG);
                Reset(dp_ViTriKho_SOBG);
                Reset(dp_Ca_SOBG);
                Clear(formData_SOBG);
                Reset(Checkbox_duyetgia_SOBG);
                Reset(dp_kenhtiepnhan_SOBG);
                Clear(TanSuatKho_sobg);
            Width: =40
            X: =1278
            Y: =213
            ZIndex: =36

        txt_Ghichu_SOBG As text:
            Align: =Align.Center
            BorderColor: =RGBA(202, 202, 202, 1)
            Color: =RGBA(255, 0, 0, 1)
            Default: |-
                =If(
                    CountRows(var_list_gia_KH) = 1 And cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                    LookUp(
                        var_list_gia_KH,
                        'Mã KH' = var_MaKH
                    ).'Ghi chú',
                    If(Checkbox_duyetgia_SOBG.Value Or Checkbox_duyetgiasup_SOBG.Value,"Duyệt giá bởi " & drd_duyet_gia_SOBG.Selected.Value)
                )
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Fill: =RGBA(241, 244, 249, 1)
            FocusedBorderThickness: =4
            Font: =Font.Arial
            Height: =30
            HintText: ="Ghi chú"
            HoverBorderColor: =App.Theme.Colors.Darker40
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            RadiusBottomLeft: =15
            RadiusBottomRight: =15
            RadiusTopLeft: =15
            RadiusTopRight: =15
            Size: =12
            Width: =300
            X: =871
            Y: =218
            ZIndex: =37

        Icon_Them_SOBG As icon.Add:
            BorderColor: =RGBA(179, 179, 179, 1)
            Color: =RGBA(8, 122, 135, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(244, 244, 244, 1)
            DisplayMode: |+
                =If(
                
                    cb_san_pham_SOBG.Selected.'Mã nhóm sp' = "NSP-00027" 
                
                    || cb_san_pham_SOBG.Selected.'Mã nhóm sp' = "NSP-000872"
                
                    || cb_san_pham_SOBG.Selected.'Mã nhóm sp' = "NSP-000409"
                
                    || cb_san_pham_SOBG.Selected.'Mã nhóm sp' = "NSP-000474"
                
                        || cb_khach_hang.Selected.'Customer name' = "Kho Wecare" || cb_khach_hang.Selected.'Customer name' = "Kho Wecare (Hồ Chí Minh)"
                
                    ,
                
                    DisplayMode.Edit,
                
                    If(
                
                        dp_MaDH_SOBG.Selected.'Loại đơn hàng' = 'Loại đơn hàng (SO báo giá)'.'Đơn hàng khuyến mãi',
                
                        DisplayMode.Edit,
                
                        If(
                
                            var_warning_gia.value 
                
                            // --- Điều kiện kiểm tra tồn kho cho đơn hàng Không VAT ---
                
                            || (
                
                                loai_don_SOBG.Text = "Không VAT"  && dp_ViTriKho_SOBG.Selected.'Tên kho' = Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho'
                
                                && (
                
                                    (Var_ton_kho_lythuyet_inventory <= 0 || IsBlank(Var_ton_kho_lythuyet_inventory))
                
                                    || Value(txt_So_luong_SOBG.Text) > Var_ton_kho_lythuyet_inventory
                
                                )
                
                            )
                
                            // --- Điều kiện kiểm tra tồn kho sau khi chuyển đổi đơn vị cho đơn Không VAT ---
                
                            || (
                
                                loai_don_SOBG.Text = "Không VAT" 
                
                                && dp_ViTriKho_SOBG.Selected.'Tên kho' = Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho'
                
                                && Value(txt_So_luong_SOBG.Text) * dp_Don_vi_SOBG.Selected.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)' > Var_ton_kho_lythuyet_inventory
                
                            )
                
                            // --- Điều kiện kiểm tra VAT và GTGT = 0% ---
                
                            || (
                
                                loai_don_SOBG.Text = "Có VAT" 
                
                                && lbl_sanpham.Text = "Sản phẩm không VAT"
                
                            )
                
                            // --- Điều kiện kiểm tra Có VAT và sản phẩm có GTGT > 0% (không cho phép sản phẩm không VAT) ---
                
                            || (
                
                                loai_don_SOBG.Text = "Có VAT" 
                
                                && Value(Substitute(Trim(cb_san_pham_SOBG.Selected.GTGT), "%", "")) = 0
                
                            )
                
                            // --- Điều kiện kiểm tra Không VAT và GTGT > 0% ---
                
                            || (
                
                                loai_don_SOBG.Text = "Đơn hàng Không VAT" 
                
                                && lbl_sanpham.Text = "Sản phẩm có VAT"
                
                            )
                
                            // --- Điều kiện kiểm tra Tên kho trống ---
                
                            || (IsBlank(Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho') And  loai_don_SOBG.Text = "Đơn hàng Không VAT"),
                
                            DisplayMode.Disabled,
                
                            DisplayMode.Edit
                
                        )
                
                    )
                
                )
                
            FocusedBorderThickness: =0
            Height: =40
            HoverBorderColor: =RGBA(50, 86, 160, 1)
            HoverColor: =ColorFade(RGBA(0, 120, 212, 1), -30%)
            Icon: =Icon.AddLibrary
            OnSelect: |
                =If(
                    !IsBlank(cb_san_pham_SOBG.Selected.'Mã sản phẩm') And !IsBlank(dp_Don_vi_SOBG.Selected.'Đơn vị chuyển đổi-Transfome') And !IsBlank(txt_So_luong_SOBG.Text) And !IsBlank(txt_Gia_SOBG.Text),
                    UpdateIf(
                        formData_SOBG,
                        ThisRecord.PromotionRecord.'Promotion type (text)' = var_selected_Promotion.TypePromotion && ThisRecord.PromotionRecord.'Cộng dồn số lượng' = 'Cộng dồn số lượng (Promotion)'.Yes && (IsBlank(ThisRecord.PromotionRecord.'Số lượng áp dụng') || var_cong_don + var_input_soluong >= ThisRecord.PromotionRecord.'Số lượng áp dụng'),
                        With(
                            {
                                giamgia: If(
                                    !IsBlank(ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3') && var_cong_don + var_input_soluong >= ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3' && (IsBlank(ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 3') Or ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 3' = var_selected_dieukhoanthanhtoan_choice),
                                    ThisRecord.PromotionRecord.'Value 3',
                                    If(
                                        IsBlank(ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 2') Or ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 2' = var_selected_dieukhoanthanhtoan_choice,
                                        ThisRecord.PromotionRecord.'Value 2',
                                        ThisRecord.PromotionRecord.Value
                                    )
                                ),
                                Value_muakem: If(
                                    !IsBlank(ThisRecord.PromotionRecord.'Value mua kèm') && (IsBlank(ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3') || ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3' > var_input_soluong),
                                    ThisRecord.PromotionRecord.'Value mua kèm',
                                    0
                                ),
                                PPHD: If(
                                    dp_MaDH_SOBG.Selected.'Loại hóa đơn' = 'Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' And dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT',
                                    1.015,
                                    1
                                ),
                                Record: ThisRecord
                            },
                            With(
                                {
                                    Gia_da_chietkhau: If(
                                        Record.PromotionRecord.'VNĐ/% Text' = "VNĐ",
                                        Record.Giá - (giamgia+Value_muakem),
                                        Record.Giá * (1 - (giamgia + Value_muakem) / 100)
                                    )
                                },
                                {
                                    '% Giảm giá': If(
                                        var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.'%',
                                        (giamgia + Value_muakem) / 100,
                                        (giamgia + Value_muakem)
                                    ),
                                    'Giá đã giảm': Gia_da_chietkhau * PPHD,
                                    'Tổng tiền': (Record.'Số lượng' * Gia_da_chietkhau * PPHD) + Record.VAT,
                                    Chietkhauphantram: If(
                                        var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.'%' && var_selected_khachhang.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                        (giamgia + Value_muakem) / 100,
                                        0
                                    ),
                                    Chietkhautien: If(
                                        var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ && var_selected_khachhang.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                        (giamgia + Value_muakem),
                                        0
                                    )
                                }
                            )
                        )
                    );
                    Collect(
                        formData_SOBG,
                        {
                            'Tên sản phẩm': cb_san_pham_SOBG.Selected.'Tên sản phẩm',
                            'Mã sản phẩm': cb_san_pham_SOBG.Selected.'Mã sản phẩm',
                            'Record sản phẩm': cb_san_pham_SOBG.Selected,
                            'Mã nhóm SP': var_selected_manhomSP,
                            'Số lượng': Value(txt_So_luong_SOBG.Text),
                            'Đơn vị': dp_Don_vi_SOBG.Selected.'Đơn vị chuyển đổi-Transfome',
                            'Record Đơn vị': dp_Don_vi_SOBG.Selected,
                            Giá: Value(txt_Gia_SOBG.Text),
                            'Giá đã giảm': If(
                                Value(txt_Gia_SOBG.Text) = 0,
                                0,
                                Value(lbl_GiaDaGiam_SOBG.Text)
                            ),
                            '% Giảm giá': If( var_selected_Checkbox_duyetgia, var_selected_theochietkhau/100,
                                var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ And cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                Value_Promotion + Value_Promtion_Muakem,
                                (Value_Promotion + Value_Promtion_Muakem) / 100
                            ),
                            'Thành Tiền': Value(lbl_Thanh_tien_SOBG.Text),
                            'Tổng tiền': Value(lbl_Tong_tien_SOBG.Text),
                            VAT: Value(dp_VAT_SOBG.Selected.Value),
                            //GTGT: Value(lbl_GTGT_SOBG.Text),
                            'Ngày giao': DateValue(dp_ngay_giao_SOBG.SelectedDate),
                            Ca: dp_Ca_SOBG.SelectedText.Value,
                            'Ngày giao NM': DateValue(dp_ngay_giao_NM_SOBG.SelectedDate),
                            MaDH: dp_MaDH_SOBG.Selected.'Mã đơn hàng',
                            STT: If(
                                Max(
                                    formData_SOBG,
                                    STT
                                ) = 0,
                                1,
                                Max(
                                    formData_SOBG,
                                    STT
                                ) + 1
                            ),
                            GhiChu: txt_Ghichu_SOBG.Text,
                            duyet_gia: drd_duyet_gia_SOBG.Selected.Value,
                            //DonhangGap: Checkbox_DHgap_1.Value,
                            Chietkhauphantram: If( var_selected_Checkbox_duyetgia, var_selected_theochietkhau/100,
                                var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.'%' And cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                (Value_Promotion + Value_Promtion_Muakem) / 100,
                                0
                            ),
                            Chietkhautien: If(
                                var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ And cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                Value_Promotion + Value_Promtion_Muakem,
                                0
                            ),
                            promotiontext: If(
                                cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                                var_selected_Promotion.NamePromotion
                            ),
                            PromotionRecord: LookUp(
                                Promotion,
                                ID = var_selected_Promotion.crdfd_promotionid
                            ),
                            id_duyetgiaSUP: First(var_duyetgiasup_SOBG).ID,
                            'Kho đáp ứng': LookUp(
                                TanSuatKho_sobg,
                                TênSảnPhẩm = cb_san_pham_SOBG.Selected.'Tên sản phẩm',
                                Kho
                            ),
                            DKTT: var_selected_Promotion.DKTT,
                            Createdon: Now(),
                            'Phụ phí hoá đơn': If(
                                dp_MaDH_SOBG.Selected.'Loại hóa đơn' = 'Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' And dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT' And var_Nganh_nghe = "Shop",
                                0.015,
                                0
                            ),
                            HinhThucGiaoHang: HT_giaohang.'Giao 1 lần'
                        }
                    );
                    If(
                        var_Nganh_nghe = "Shop",
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Thiết bị nước" || 'Record sản phẩm'.'Cấp 4' = "Ống cứng PVC"
                            ),
                            ((var_count_thiet_bi_nuoc >= 50 && var_sum_thiet_bi_nuoc >= 100000000) || var_sum_ong_cung >= 100000000),
                            {
                                'Ngày giao': DateAdd(
                                    DateTimeValue(ngay_giao),
                                    If(
                                        var_sum_thiet_bi_nuoc >= 200000000 || var_sum_ong_cung >= 200000000,
                                        24,
                                        12
                                    ),
                                    TimeUnit.Hours
                                ),
                                Ca: If(
                                    Hour(
                                        DateAdd(
                                            DateTimeValue(ngay_giao),
                                            If(
                                                var_sum_thiet_bi_nuoc >= 200000000 || var_sum_ong_cung >= 200000000,
                                                24,
                                                12
                                            ),
                                            TimeUnit.Hours
                                        )
                                    ) <= 12,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Thiết bị điện"
                            ),
                            var_sum_thiet_bi_dien >= 200000000,
                            {
                                'Ngày giao': DateAdd(
                                    DateTimeValue(ngay_giao),
                                    12,
                                    TimeUnit.Hours
                                ),
                                Ca: If(
                                    Hour(
                                        DateAdd(
                                            DateTimeValue(ngay_giao),
                                            12,
                                            TimeUnit.Hours
                                        )
                                    ) >= 0 && Hour(
                                        DateAdd(
                                            DateTimeValue(ngay_giao),
                                            12,
                                            TimeUnit.Hours
                                        )
                                    ) <= 12,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Vật tư kim khí"
                            ),
                            var_count_kim_khi >= 100,
                            {
                                'Ngày giao': DateAdd(
                                    DateTimeValue(ngay_giao),
                                    12,
                                    TimeUnit.Hours
                                ),
                                Ca: If(
                                    Hour(
                                        DateAdd(
                                            DateTimeValue(ngay_giao),
                                            12,
                                            TimeUnit.Hours
                                        )
                                    ) >= 0 && Hour(
                                        DateAdd(
                                            DateTimeValue(ngay_giao),
                                            12,
                                            TimeUnit.Hours
                                        )
                                    ) <= 12,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                    );
                    Reset(cb_san_pham_SOBG);
                    Reset(dp_Don_vi_SOBG);
                    Reset(txt_So_luong_SOBG);
                    Reset(txt_Gia_SOBG);
                    Reset(dp_VAT_SOBG);
                    Reset(drd_duyet_gia_SOBG);
                    Reset(dp_ngay_giao_SOBG);
                    Reset(Checkbox_duyetgiasup_SOBG);
                    Reset(Checkbox_duyetgia_SOBG),
                    Notify(
                        "Vui lòng điền đầy đủ thông tin!!",
                        NotificationType.Warning,
                        1000
                    )
                );
                Clear(TanSuatKho_sobg);
                ForAll(
                    formData_SOBG As ColData,
                    ForAll(
                        var_filterkho_SOBG As Kho,
                        If(
                            CountRows(
                                Filter(
                                    'Kho Bình Định',
                                    'Vị trí kho'.'Tên kho' = Kho.'Tên kho' && 'Tên sản phẩm'.'Tên sản phẩm' = ColData.'Tên sản phẩm' && 'Tồn kho lý thuyết - Bỏ mua' >= ColData.'Số lượng'
                                )
                            ) > 0,
                            Collect(
                                TanSuatKho_sobg,
                                {
                                    TênSảnPhẩm: ColData.'Tên sản phẩm',
                                    SốLượng: ColData.'Số lượng',
                                    Kho: Kho.'Tên kho'
                                }
                            )
                        )
                    )
                );
                With(
                    {tempData: formData_SOBG},
                    ForAll(
                        tempData As ColData,
                        Patch(
                            formData_SOBG,
                            LookUp(
                                formData_SOBG,
                                'Tên sản phẩm' = ColData.'Tên sản phẩm'
                            ),
                            {
                                'Kho đáp ứng': LookUp(
                                    TanSuatKho_sobg,
                                    TênSảnPhẩm = ColData.'Tên sản phẩm',
                                    Kho
                                )
                            }
                        )
                    )
                );
                Reset(dp_Ca_SOBG);
            Width: =40
            X: =1179
            Y: =213
            ZIndex: =38

        icon_Cancel_SOBG As icon.Save:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(8, 122, 135, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(244, 244, 244, 1)
            Height: =40
            Icon: =Icon.Cancel
            OnSelect: |
                =UpdateContext({formdata_selected: Data_don_chi_tiet_SOBG.Selected});
                //remove STT
                RemoveIf(
                    formData_SOBG,
                    STT = formdata_selected.STT
                );
                //deactive
                UpdateIf(
                    'SOD báo giá',
                    ID = formdata_selected.'ID đơn hàng',
                    {Status: 'Status (SOD báo giá)'.Inactive}
                );
                UpdateContext(
                    {
                        data_muakem: Filter(
                            Promotion,
                            (formdata_selected.'Mã sản phẩm' in 'Mã sản phẩm (mua kèm)' || formdata_selected.'Mã nhóm SP' in 'Mã nhóm sp (Mua kèm)') && Status = 'Status (Promotion)'.Active
                        )
                    }
                );
                ForAll(
                    data_muakem As data_muakem,
                    If(
                        (CountIf(
                            List_Ma_SP_formdata,
                            Text(Value) in data_muakem.'Mã sản phẩm (mua kèm)'
                        ) = 0 And !IsBlank(data_muakem.'Mã sản phẩm (mua kèm)')) || (CountIf(
                            List_Ma_NSP_formdata,
                            Text(Value) in data_muakem.'Mã nhóm sp (Mua kèm)'
                        ) = 0 And !IsBlank(data_muakem.'Mã nhóm sp (Mua kèm)')),
                        With(
                            {
                                heSoVAT: If(
                                    dp_MaDH_SOBG.Selected.'Loại hóa đơn' = 'Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' && dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT',
                                    1.015,
                                    1
                                )
                            },
                            ForAll(
                                Filter(
                                    formData_SOBG,
                                    PromotionRecord.ID = data_muakem.ID
                                ),
                                Patch(
                                    formData_SOBG,
                                    ThisRecord,
                                    {
                                        PromotionRecord: Blank(),
                                        'Giá đã giảm': ThisRecord.Giá * heSoVAT,
                                        'Tổng tiền': ThisRecord.Giá * heSoVAT * (1 + ThisRecord.VAT),
                                        '% Giảm giá': 0,
                                        Chietkhauphantram: 0,
                                        Chietkhautien: 0
                                    }
                                )
                            )
                        )
                    )
                );
                // Update record collection với giá trị mới với trường hợp cộng dồn
                With(
                    {
                        value: Sum(
                            Filter(
                                formData_SOBG,
                                PromotionRecord.'Promotion type (text)' = formdata_selected.PromotionRecord.'Promotion type (text)' && ThisRecord.PromotionRecord.'Cộng dồn số lượng' = 'Cộng dồn số lượng (Promotion)'.Yes
                            ),
                            'Số lượng'
                        )
                    },
                    UpdateIf(
                        formData_SOBG,
                        ThisRecord.PromotionRecord.'Promotion type (text)' = formdata_selected.PromotionRecord.'Promotion type (text)' && ThisRecord.PromotionRecord.'Cộng dồn số lượng' = 'Cộng dồn số lượng (Promotion)'.Yes,
                        With(
                            {
                                promoValue: If(
                                    !IsBlank(ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3') && value >= ThisRecord.PromotionRecord.'Số lượng áp dụng mức 3' && (IsBlank(ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 3') Or ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 3' = var_selected_dieukhoanthanhtoan_choice),
                                    ThisRecord.PromotionRecord.'Value 3',
                                    If(
                                        !IsBlank(ThisRecord.PromotionRecord.'Số lượng áp dụng') && value >= ThisRecord.PromotionRecord.'Số lượng áp dụng' && (IsBlank(ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 2') Or ThisRecord.PromotionRecord.'Điều khoản thanh toán áp dụng mức 2' = var_selected_dieukhoanthanhtoan_choice),
                                        ThisRecord.PromotionRecord.'Value 2',
                                        ThisRecord.PromotionRecord.Value
                                    )
                                ),
                                PPHD: If(
                                    dp_MaDH_SOBG.Selected.'Loại hóa đơn' = 'Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' And dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT',
                                    1.015,
                                    1
                                ),
                                Record: ThisRecord
                            },
                            With(
                                {
                                    Gia_da_chietkhau: If(
                                        Record.PromotionRecord.'VNĐ/% Text' = "VNĐ",
                                        Record.Giá - promoValue,
                                        Record.Giá * (1 - promoValue / 100)
                                    )
                                },
                                {
                                    '% Giảm giá': If(
                                        Record.PromotionRecord.'VNĐ/% Text' = "%",
                                        promoValue / 100,
                                        promoValue
                                    ),
                                    'Giá đã giảm': Gia_da_chietkhau * PPHD,
                                    'Tổng tiền': (Record.'Số lượng' * Gia_da_chietkhau * PPHD) + Record.VAT,
                                    Chietkhauphantram: If(
                                        Record.PromotionRecord.'VNĐ/% Text' = "%" && var_Nganh_nghe = "Shop",
                                        promoValue / 100,
                                        0
                                    ),
                                    Chietkhautien: If(
                                        Record.PromotionRecord.'VNĐ/% Text' = "VNĐ" && var_Nganh_nghe = "Shop",
                                        promoValue,
                                        0
                                    )
                                }
                            )
                        )
                    );
                    If(
                        var_Nganh_nghe = "Shop",
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Thiết bị nước" || 'Record sản phẩm'.'Cấp 4' = "Ống cứng PVC"
                            ),
                            var_sum_thiet_bi_nuoc < 200000000 || var_sum_ong_cung < 200000000,
                            {
                                'Ngày giao': If(
                                    var_count_thiet_bi_nuoc < 50 || var_sum_ong_cung < 100000000,
                                    DateTimeValue(ngay_giao_SOBG),
                                    If(
                                        var_count_thiet_bi_nuoc >= 50 && var_sum_thiet_bi_nuoc >= 100000000,
                                        DateAdd(
                                            DateTimeValue(ngay_giao_SOBG),
                                            12,
                                            TimeUnit.Hours
                                        ),
                                        DateTimeValue(ngay_giao_SOBG)
                                    )
                                ),
                                Ca: If(
                                    Hour(
                                        If(
                                            var_count_thiet_bi_nuoc < 50 || var_sum_ong_cung < 100000000,
                                            DateTimeValue(ngay_giao_SOBG),
                                            If(
                                                var_count_thiet_bi_nuoc >= 50 && var_sum_thiet_bi_nuoc >= 100000000,
                                                DateAdd(
                                                    DateTimeValue(ngay_giao_SOBG),
                                                    12,
                                                    TimeUnit.Hours
                                                ),
                                                DateTimeValue(ngay_giao_SOBG)
                                            )
                                        )
                                    ) >= 0 && Hour(
                                        If(
                                            var_count_thiet_bi_nuoc < 50 || var_sum_ong_cung < 100000000,
                                            DateTimeValue(ngay_giao_SOBG),
                                            If(
                                                var_count_thiet_bi_nuoc >= 50 && var_sum_thiet_bi_nuoc >= 100000000,
                                                DateAdd(
                                                    DateTimeValue(ngay_giao_SOBG),
                                                    12,
                                                    TimeUnit.Hours
                                                ),
                                                DateTimeValue(ngay_giao_SOBG)
                                            )
                                        )
                                    ) <= 12,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Thiết bị điện"
                            ),
                            var_sum_thiet_bi_dien < 200000000,
                            {
                                'Ngày giao': DateTimeValue(ngay_giao_SOBG),
                                Ca: If(
                                    var_Ca,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                        UpdateIf(
                            Filter(
                                formData_SOBG,
                                'Record sản phẩm'.'Cấp 2 NHSP' = "Vật tư kim khí"
                            ),
                            var_count_kim_khi < 100,
                            {
                                'Ngày giao': DateAdd(
                                    DateTimeValue(ngay_giao_SOBG),
                                    0,
                                    TimeUnit.Hours
                                ),
                                Ca: If(
                                    var_Ca,
                                    'Ca (SOD báo giá)'.'Ca sáng',
                                    'Ca (SOD báo giá)'.'Ca chiều'
                                )
                            }
                        );
                    );
                    
                );
                ClearCollect(
                    formData_SOBG,
                    ForAll(
                        Sequence(
                            CountRows(
                                Sort(
                                    formData_SOBG,
                                    Createdon,
                                    SortOrder.Ascending
                                )
                            )
                        ),
                        Patch(
                            Last(
                                FirstN(
                                    Sort(
                                        formData_SOBG,
                                        Createdon,
                                        SortOrder.Ascending
                                    ),
                                    Value
                                )
                            ),
                            {STT: Value}
                        )
                    )
                );
                If(
                    !IsBlank(formdata_selected.'ID đơn hàng'),
                    ForAll(
                        formData_SOBG,
                        Patch(
                            'SOD báo giá',
                            LookUp(
                                'SOD báo giá',
                                ID = formData_SOBG[@'ID đơn hàng']
                            ),
                            {
                                'Đơn giá': If(
                                    var_Nganh_nghe = "Shop",
                                    formData_SOBG[@'Giá đã giảm'],
                                    formData_SOBG[@Giá]
                                ),
                                //'Giá gốc': Value(formData_SOBG[@Giá]),
                                'Stt đơn': formData_SOBG[@STT],
                                'Chiết khấu %': formData_SOBG[@Chietkhauphantram],
                                'Chiết khấu VNĐ': formData_SOBG[@Chietkhautien]
                            }
                        )
                    );
                    ,
                    false
                );
                Notify(
                    "Cập nhật thành công",
                    NotificationType.Success,
                    2000
                );
                Clear(TanSuatKho);
                ForAll(
                    formData As ColData,
                    ForAll(
                        var_filterkho As Kho,
                        If(
                            CountRows(
                                Filter(
                                    'Kho Bình Định',
                                    'Vị trí kho'.'Tên kho' = Kho.'Tên kho' && 'Tên sản phẩm'.'Tên sản phẩm' = ColData.'Tên sản phẩm' && 'Tồn kho lý thuyết - Bỏ mua' >= ColData.'Số lượng'
                                )
                            ) > 0,
                            Collect(
                                TanSuatKho,
                                {
                                    TênSảnPhẩm: ColData.'Tên sản phẩm',
                                    SốLượng: ColData.'Số lượng',
                                    Kho: Kho.'Tên kho'
                                }
                            )
                        )
                    )
                );
                With(
                    {tempData: formData},
                    ForAll(
                        tempData As ColData,
                        Patch(
                            formData,
                            LookUp(
                                formData,
                                'Tên sản phẩm' = ColData.'Tên sản phẩm'
                            ),
                            {
                                'Kho đáp ứng': LookUp(
                                    TanSuatKho,
                                    TênSảnPhẩm = ColData.'Tên sản phẩm',
                                    Kho
                                )
                            }
                        )
                    )
                );
            Visible: =CountRows(formData_SOBG) > 0
            Width: =40
            X: =1326
            Y: =213
            ZIndex: =39

        lbl_thongbao_SOBG As label:
            Align: =Align.Center
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(255, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Size: =11
            Text: |-
                =If(false, "Khách chưa được thêm vào nhóm BGCT",
                "Sản phẩm chưa báo giá cho đơn vị " & dp_Don_vi_SOBG.Selected.'Đơn vị chuyển đổi-Transfome' & " !!")
            Visible: =IsBlank(txt_Gia_SOBG.Text) And !IsBlank(var_selected_maSP)
            Width: =308
            X: =334
            Y: =211
            ZIndex: =40

        drd_duyet_gia_SOBG As Dropdown.pcfdataset:
            Appearance: ="FilledDarker"
            BorderColor: =RGBA(106, 122, 127, 0.38)
            BorderStyle: =BorderStyle.Solid
            BorderThickness: =2
            DefaultSelectedItems: |-
                =If(
                    Checkbox_duyetgia_SOBG.Value Or Checkbox_duyetgiasup_SOBG.Value,
                    If(
                        cb_khach_hang_SOBG.Selected.'Ngành nghề' = 'Ngành nghề mới'.Shop,
                        If(
                            !IsBlank(First(var_duyetgiasup_SOBG).'Người duyệt'.Name) And Checkbox_duyetgiasup_SOBG.Value,
                            [First(var_duyetgiasup_SOBG).'Người duyệt'.Name],
                            ["Lê Thị Ngọc Anh"]
                        ),
                        ["Phạm Thị Mỹ Hương"]
                    ),
                    []
                )
            DisplayMode: =DisplayMode.Edit
            Height: =32
            Items: =var_table_supduyet
            Visible: =true
            Width: =200
            X: =656
            Y: =219
            ZIndex: =41

    lbl_khodexuat_SOBG As label:
        BorderColor: =App.Theme.Colors.Darker40
        Color: =RGBA(255, 0, 0, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Font: =App.Theme.Font
        Height: =25
        Size: =11
        Text: |-
            ="Kho đề xuất: "
        Visible: =cb_khach_hang_SOBG.Selected.'Ngành nghề text' = "5. Shop bán lẻ"
        Width: =96
        X: =6
        Y: =200
        ZIndex: =49

    lb_suggest_kho_SOBG As label:
        BorderColor: =App.Theme.Colors.Darker40
        Color: =RGBA(255, 0, 0, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        Font: =App.Theme.Font
        Height: =24
        Role: =
        Size: =11
        Text: |-
            =If(IsEmpty(TanSuatKho_sobg),
            var_MultiChoiceKho_SOBG.'Vị trí kho'.'Tên kho',
            First(
                Filter(
                    AddColumns(
                        GroupBy(
                            TanSuatKho_sobg,
                            Kho,
                            Group_theo_kho
                        ),
                        SốLượng,
                        CountRows(Group_theo_kho)
                    ),
                    SốLượng = Max(
                        AddColumns(
                            GroupBy(
                                TanSuatKho_sobg,
                                Kho,
                                Group
                            ),
                            SốLượng,
                            CountRows(Group)
                        ),
                        SốLượng
                    ) && 
                    If(
                        CountRows(
                            Filter(
                                AddColumns(
                                    GroupBy(
                                        TanSuatKho_sobg,
                                        Kho,
                                        Group
                                    ),
                                    SốLượng,
                                    CountRows(Group)
                                ),
                                SốLượng = Max(
                                    AddColumns(
                                        GroupBy(
                                            TanSuatKho_sobg,
                                            Kho,
                                            Group
                                        ),
                                        SốLượng,
                                        CountRows(Group)
                                    ),
                                    SốLượng
                                )
                            )
                        ) > 1,
                        Kho = var_MultiChoiceKho_SOBG.'Vị trí kho'.'Tên kho',
                        true
                    ),
                    Kho
                )
            ).Kho
            )
        Visible: =cb_khach_hang_SOBG.Selected.'Ngành nghề text' = "5. Shop bán lẻ"
        Width: =172
        X: =94
        Y: =201
        ZIndex: =50

    dp_Ca_SOBG As dropdown:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderThickness: =1
        ChevronBackground: =RGBA(0, 0, 0, 0)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =RGBA(255, 255, 255, 1)
        Color: =RGBA(77, 77, 77, 1)
        Default: =If(var_Ca_SOBG, "Ca sáng", "Ca chiều")
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        DisplayMode: =If(IsBlank(dp_MaDH_SOBG.Selected.'Mã đơn hàng'), DisplayMode.Disabled, DisplayMode.Edit)
        Font: =Font.Arial
        Height: =23
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        Items: =colCaSOBG
        PressedColor: =RGBA(255, 255, 255, 1)
        PressedFill: =App.Theme.Colors.Darker30
        Reset: =reset_control
        SelectionFill: =App.Theme.Colors.Primary
        Size: =12
        Visible: =If(var_Nganh_nghe = "Shop", true, false)
        Width: =110
        X: =225
        Y: =227
        ZIndex: =51

    C_showPopupPromotionOrder_1 As groupContainer.manualLayoutContainer:
        DropShadow: =DropShadow.Light
        Fill: =RGBA(189, 189, 189, 0.67)
        Height: =768
        RadiusBottomLeft: =4
        RadiusBottomRight: =4
        RadiusTopLeft: =4
        RadiusTopRight: =4
        Visible: =Popup_PromotionOrder 
        Width: =1366
        ZIndex: =53

        Group8 As group:
            Height: =5
            Width: =5
            X: =0
            Y: =0
            ZIndex: =6

            Button1_2 As button:
                BorderColor: =App.Theme.Colors.Primary
                Color: =App.Theme.Colors.PrimaryForeground
                DisabledBorderColor: =RGBA(244, 244, 244, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =DisplayMode.View
                Fill: =RGBA(255, 255, 255, 0.95)
                Font: =App.Theme.Font
                FontWeight: =FontWeight.Semibold
                Height: =234
                HoverBorderColor: =App.Theme.Colors.Darker10
                HoverColor: =App.Theme.Colors.PrimaryForeground
                HoverFill: =App.Theme.Colors.Darker10
                PressedBorderColor: =App.Theme.Colors.Darker40
                PressedColor: =Self.Color
                PressedFill: =App.Theme.Colors.Darker40
                RadiusBottomLeft: =30
                RadiusBottomRight: =30
                RadiusTopLeft: =30
                RadiusTopRight: =30
                Size: =15
                Text: =
                Width: =556
                X: =387
                Y: =267
                ZIndex: =1

            bt_huy_2 As Button:
                AcceptsFocus: =true
                AccessibleLabel: =""
                Align: =""
                Appearance: =
                BasePaletteColor: =RGBA(189, 178, 176, 1)
                BorderColor: =
                BorderRadius: =10
                BorderStyle: =""
                ContentLanguage: =""
                DisplayMode: =DisplayMode.Edit
                Font: =Font.Arial
                FontColor: =
                FontItalic: =false
                FontSize: =16
                FontStrikethrough: =false
                FontUnderline: =false
                FontWeight: =FontWeight.Semibold
                Height: =40
                Icon: =""
                IconRotation: =0
                IconStyle: ="Outline"
                Layout: ="Icon before"
                OnSelect: |-
                    =UpdateContext({Popup_PromotionOrder:false});
                    Reset(Combobox_PromotionOrder_1);
                TabIndex: =0
                Text: ="Huỷ"
                Tooltip: =""
                VerticalAlign: =""
                Visible: =true
                Width: =160
                X: =713
                Y: =428
                ZIndex: =2

            Label_lydohuy_3 As label:
                BorderColor: =App.Theme.Colors.Darker40
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Font: =App.Theme.Font
                FontWeight: =FontWeight.Semibold
                Height: =35
                Size: =18
                Text: ="Promotion Order "
                Width: =500
                X: =419
                Y: =274
                ZIndex: =3

            Combobox_PromotionOrder_1 As Combobox.pcfdataset:
                AccessibleLabel: =""
                Appearance: ="FilledDarker"
                BorderStyle: =""
                ContentLanguage: =""
                DisplayMode: =DisplayMode.Edit
                Font: =Font.Arial
                FontItalic: =false
                FontSize: =18
                FontStrikethrough: =false
                FontUnderline: =false
                FontWeight: =FontWeight.Normal
                Height: =49
                InputTextPlaceholder: ="Promotion Order"
                IsSearchable: =false
                Items: =Promotion_Order_Max
                MultiValueDelimiter: =", "
                OnChange: =
                Required: =false
                SelectMultiple: =true
                TabIndex: =0
                Tooltip: =""
                TriggerOutput: ="Keypress"
                ValidationState: ="None"
                Visible: =true
                Width: =468
                X: =431
                Y: =339
                ZIndex: =4

                NamePromotion1_1 As PowerApps_CoreControls_ComboboxCanvasTemplate_dataField.textualColumn:
                    FieldDisplayName: ="NamePromotion"
                    FieldName: ="NamePromotion"
                    FieldType: ="s"
                    Order: =1
                    Type: ="s"
                    ZIndex: =1

            Timer_Promotion_1 As timer:
                AutoPause: =false
                BorderColor: =App.Theme.Colors.Primary
                Color: =App.Theme.Colors.PrimaryForeground
                DisabledBorderColor: =RGBA(244, 244, 244, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =If(!IsBlank(Combobox_PromotionOrder_1.Selected), DisplayMode.Edit,DisplayMode.Disabled)
                Fill: =App.Theme.Colors.Primary
                Font: =App.Theme.Font
                FontWeight: =FontWeight.Semibold
                HoverBorderColor: =App.Theme.Colors.Darker10
                HoverColor: =App.Theme.Colors.PrimaryForeground
                HoverFill: =App.Theme.Colors.Darker10
                OnTimerEnd: |
                    =UpdateContext({showLoading: false});
                    ForAll(
                        Combobox_PromotionOrder_1.SelectedItems As This, 
                        Patch(
                            'SO báo giá x Promotion',
                            Defaults('SO báo giá x Promotion'),
                            {
                                'SO báo giá': lookup_donhang_SOBG,
                                Promotion: LookUp(Promotion,ID =This.crdfd_promotionid),
                                Type: "Order",
                                Loại: If(
                                    This.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ,
                                    "Tiền",
                                    "Phần trăm"
                                ),
                                'Chiết khấu': If(
                                    This.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ,
                                    This.ValuePromotion,
                                    This.ValuePromotion / 100
                                )
                            }
                        )
                    );
                    Patch(
                        'SO báo giá',
                        lookup_donhang_SOBG,
                        {
                            'Chiết khấu VNĐ':lookup_donhang_SOBG.'Chiết khấu VNĐ'+ Sum(
                                Filter(
                                    Combobox_PromotionOrder_1.SelectedItems,
                                    VND_Percent = 'VNĐ/% (Promotion)'.VNĐ
                                ),
                                ValuePromotion
                            )
                        }
                    );
                    Reset(Combobox_PromotionOrder_1);
                    Notify(
                        "Áp dụng thành công",
                        NotificationType.Success,
                        5000
                    );
                    UpdateContext({Popup_PromotionOrder: false});
                OnTimerStart: |-
                    =UpdateContext({showLoading: true});
                PressedBorderColor: =App.Theme.Colors.Darker40
                PressedColor: =Self.Color
                PressedFill: =App.Theme.Colors.Darker40
                RadiusBottomLeft: =15
                RadiusBottomRight: =15
                RadiusTopLeft: =15
                RadiusTopRight: =15
                Reset: =true
                Size: =14
                Start: =true
                Text: |-
                    =If(!IsBlank(Combobox_PromotionOrder_1.Selected) And showLoading ,Text(Time(0, 0, Round((Self.Duration - Self.Value) / 1000, 0)), "mm:ss"), "Xác nhận")
                X: =448
                Y: =428
                ZIndex: =5

    dp_kenhtiepnhan_SOBG As dropdown:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderThickness: =1
        ChevronBackground: =RGBA(0, 0, 0, 0)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =App.Theme.Colors.PrimaryForeground
        Color: =RGBA(77, 77, 77, 1)
        Default: =//var_KenhTiepNhan
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Font: =App.Theme.Font
        Height: =24
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        Items: =Choices('SO báo giá'.'Kênh tiếp nhận SOBG')
        OnSelect: |-
            =//UpdateContext({var_kenhtiepnhan_isSelected: true});
        PressedColor: =App.Theme.Colors.PrimaryForeground
        PressedFill: =App.Theme.Colors.Darker30
        SelectionColor: =App.Theme.Colors.PrimaryForeground
        SelectionFill: =App.Theme.Colors.Primary
        Size: =12
        Visible: =false//If(var_Nganh_nghe = "Shop", true, false)
        Width: =110
        X: =225
        Y: =201
        ZIndex: =54

    Group5 As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =54

        cb_khach_hang_SOBG As combobox:
            BorderColor: =RGBA(202, 202, 202, 1)
            ChevronBackground: =RGBA(255, 255, 255, 1)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayFields: =["crdfd_name"]
            Font: =Font.Arial
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            InputTextPlaceholder: ="Khách hàng"
            Items: |-
                =Sort(
                    Filter(
                        Customers,
                        Status = 'Status (Customers)'.Active,
                        'Loại đối tượng' = 'Loại đối tượng - KH'.'Khách hàng',
                        //'Local ' = "Quy Nhơn",
                        'Trạng thái KH' = 'Trạng thái KH (Customers)'.'Khách hàng chính thức' Or 'Trạng thái KH' = 'Trạng thái KH (Customers)'.'Khách hàng tạo mới'
                    ),
                    'Customer name'
                )
            OnChange: |-
                =
                Reset(dp_VAT_SOBG);
                Reset(cb_san_pham_SOBG);
                Reset(dp_Don_vi_SOBG);
                Reset(txt_So_luong_SOBG);
                Reset(txt_Gia_SOBG);
                //Reset(dp_Giam_gia);
                Reset(dp_ngay_giao_SOBG);
                ClearCollect(
                    colCaSOBG,
                    {Ca: "Ca sáng"},
                    {Ca: "Ca chiều"}
                )
            PressedColor: =RGBA(116, 116, 116, 1)
            PressedFill: =App.Theme.Colors.Darker30
            SearchFields: =["crdfd_name"]
            SearchItems: =Search(Sort(Filter(Customers,Status='Status (Customers)'.Active,'Loại đối tượng'='Loại đối tượng - KH'.'Khách hàng','Trạng thái KH'='Trạng thái KH (Customers)'.'Khách hàng chính thức' Or 'Trạng thái KH'='Trạng thái KH (Customers)'.'Khách hàng tạo mới'),'Customer name'),cb_khach_hang_SOBG.SearchText,'Customer name')
            SelectionFill: =App.Theme.Colors.Primary
            SelectMultiple: =false
            Size: =12
            Width: =400
            X: =11
            Y: =30
            ZIndex: =3

        lbl_Khachhang_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: ="Khách hàng"
            X: =10
            ZIndex: =4

        lbl_Donhang_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: ="Đơn hàng " & dp_MaDH_SOBG.Selected.VAT &" "& var_selected_Checkbox_duyetgia & var_selected_theochietkhau/100 
            Width: =340
            X: =dp_MaDH_SOBG.X
            ZIndex: =5

        dp_MaDH_SOBG As combobox:
            BorderColor: =RGBA(202, 202, 202, 1)
            ChevronBackground: =RGBA(255, 255, 255, 1)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            DefaultSelectedItems: =First(var_DHBG)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayFields: =["crdfd_name"]
            Font: =Font.Arial
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            InputTextPlaceholder: ="SO báo giá"
            IsSearchable: =false
            Items: =var_DHBG
            OnChange: |
                =Clear(formData_SOBG);
                ForAll(
                    var_SODBG As itemSODBG,
                    With(
                        {
                            mappedApproval: LookUp(
                                var_table_duyetgia_SOBG,
                                Value = itemSODBG[@'Duyệt giá'],
                                Name
                            ),
                            Promoption_Record: LookUp(
                                Promotion,
                                ID = itemSODBG[@Promotion].ID
                            )
                        },
                        Collect(
                            formData_SOBG,
                            {
                                STT: itemSODBG[@'Stt đơn'],
                                'ID đơn hàng': itemSODBG[@ID],
                                'Tên sản phẩm': itemSODBG[@'sản phẩm text'],
                                'Mã sản phẩm': itemSODBG[@'Mã sản phẩm'],
                                'Mã nhóm SP': itemSODBG[@'Mã nhóm sản phẩm'],
                                'Record Đơn vị': itemSODBG[@'Đơn vị'],
                                'Record sản phẩm': itemSODBG[@'Sản phẩm'],
                                'Số lượng': itemSODBG[@'Số lượng'],
                                'Đơn vị': itemSODBG[@'Đơn vị text'],
                                Giá: itemSODBG[@'Giá gốc'],
                                'Phụ phí hoá đơn': itemSODBG[@'Phụ phí hoá đơn (%)'],
                                'Giá đã giảm': itemSODBG[@'Đơn giá'],
                                '% Giảm giá': If(
                                    itemSODBG[@'Chiết khấu %'] > 0,
                                    itemSODBG[@'Chiết khấu %'],
                                    itemSODBG[@'Chiết khấu VNĐ']
                                ),
                                'Tổng tiền': With(
                                    {
                                        TotalExVAT: itemSODBG[@'Tổng tiền chưa VAT'],
                                        AdjustGTGT: Value(itemSODBG[@'Điều chỉnh GTGT Text'])
                                    },
                                    TotalExVAT * (1 + If(
                                        AdjustGTGT <> 0,
                                        AdjustGTGT / 100,
                                        0
                                    ))
                                ),
                                VAT: Value(itemSODBG[@'Điều chỉnh GTGT Text']),
                                'Ngày giao': itemSODBG[@'Ngày giao dự kiến'],
                                Ca: If(
                                    itemSODBG[@Ca] = 283640000,
                                    "Ca sáng",
                                    "Ca chiều"
                                ),
                                'Ngày giao NM': itemSODBG[@'Ngày giao dự kiến'],
                                GhiChu: itemSODBG[@'Ghi chú'],
                                GTGT: itemSODBG[@GTGT],
                                Chietkhauphantram: itemSODBG[@'Chiết khấu %'],
                                Chietkhautien: itemSODBG[@'Chiết khấu VNĐ'],
                                promotiontext: itemSODBG[@'Promotion text'],
                                PromotionRecord: Promoption_Record,
                                duyet_gia: mappedApproval,
                                Createdon: itemSODBG[@'Created On']
                            }
                        )
                    )
                );
                //UpdateContext({var_kenhtiepnhan_isSelected: false});
            PressedColor: =RGBA(116, 116, 116, 1)
            PressedFill: =App.Theme.Colors.Darker30
            SearchFields: =["crdfd_dieukhoanthanhtoancal"]
            SearchItems: =Search(var_DHBG,dp_MaDH_SOBG.SearchText,'Điều khoản thanh toán CAL')
            SelectionFill: =App.Theme.Colors.Primary
            SelectMultiple: =false
            Size: =12
            Width: =650
            X: =460
            Y: =30
            ZIndex: =46

    C_showPopupNhacNhoKenhTiepNhan_1 As groupContainer.manualLayoutContainer:
        DropShadow: =DropShadow.Light
        Fill: =RGBA(189, 189, 189, 0.67)
        Height: =768
        RadiusBottomLeft: =4
        RadiusBottomRight: =4
        RadiusTopLeft: =4
        RadiusTopRight: =4
        Visible: =show_popup_nhacchonkenhtiepnhan
        Width: =1366
        ZIndex: =55

        NhacChonKenhTiepNhan_1 As group:
            Height: =5
            minimumHeight: =5
            minimumWidth: =5
            Visible: =true
            Width: =5
            X: =0
            Y: =0
            ZIndex: =0

            Nền_2 As button:
                BorderColor: =App.Theme.Colors.Primary
                Color: =App.Theme.Colors.PrimaryForeground
                DisabledBorderColor: =RGBA(244, 244, 244, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                DisabledFill: =RGBA(244, 244, 244, 1)
                DisplayMode: =DisplayMode.View
                Fill: =RGBA(255, 255, 255, 0.95)
                Font: =App.Theme.Font
                FontWeight: =FontWeight.Semibold
                Height: =201
                HoverBorderColor: =App.Theme.Colors.Darker10
                HoverColor: =App.Theme.Colors.PrimaryForeground
                HoverFill: =App.Theme.Colors.Darker10
                PressedBorderColor: =App.Theme.Colors.Darker40
                PressedColor: =Self.Color
                PressedFill: =App.Theme.Colors.Darker40
                RadiusBottomLeft: =30
                RadiusBottomRight: =30
                RadiusTopLeft: =30
                RadiusTopRight: =30
                Size: =15
                Text: =
                Width: =514
                X: =401
                Y: =268
                ZIndex: =1

            bt_xacnhannhacnho_1 As Button:
                AcceptsFocus: =true
                AccessibleLabel: =""
                Align: =""
                Appearance: =
                BasePaletteColor: =RGBA(8, 222, 8, 1)
                BorderColor: =
                BorderRadius: =10
                BorderStyle: =""
                ContentLanguage: =""
                DisplayMode: =DisplayMode.Edit
                Font: =Font.Arial
                FontColor: =
                FontItalic: =false
                FontSize: =16
                FontStrikethrough: =false
                FontUnderline: =false
                FontWeight: =FontWeight.Semibold
                Height: =40
                Icon: =""
                IconRotation: =0
                IconStyle: ="Outline"
                Layout: ="Icon before"
                OnSelect: |-
                    =//UpdateContext({var_kenhtiepnhan_isSelected: false});
                    //UpdateContext({show_popup_nhacchonkenhtiepnhan:false});
                TabIndex: =0
                Text: ="Đóng"
                Tooltip: =""
                VerticalAlign: =""
                Visible: =show_popup_nhacchonkenhtiepnhan
                Width: =160
                X: =702
                Y: =387
                ZIndex: =2

            Label_lydohuy_5 As label:
                BorderColor: =App.Theme.Colors.Darker40
                Color: =RGBA(0, 0, 0, 1)
                DisabledColor: =RGBA(166, 166, 166, 1)
                Font: =App.Theme.Font
                FontWeight: =FontWeight.Semibold
                Height: =51
                Size: =18
                Text: ="Kiểm tra chọn kênh tiếp nhận"
                Visible: =CountIf(OrderxPromotion_Order,true) = 0
                Width: =500
                X: =415
                Y: =292
                ZIndex: =3

        Button_Nền_2 As button:
            BorderColor: =App.Theme.Colors.Primary
            BorderThickness: =0
            Color: =App.Theme.Colors.PrimaryForeground
            DisabledBorderColor: =RGBA(244, 244, 244, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayMode: =DisplayMode.View
            Fill: =RGBA(255, 255, 255, 1)
            Font: =App.Theme.Font
            FontWeight: =FontWeight.Semibold
            Height: =324
            HoverBorderColor: =App.Theme.Colors.Darker10
            HoverColor: =App.Theme.Colors.PrimaryForeground
            HoverFill: =App.Theme.Colors.Darker10
            PressedBorderColor: =App.Theme.Colors.Darker40
            PressedColor: =Self.Color
            PressedFill: =App.Theme.Colors.Darker40
            RadiusBottomLeft: =30
            RadiusBottomRight: =30
            RadiusTopLeft: =30
            RadiusTopRight: =30
            Size: =15
            Text: ="Button"
            Visible: =
            Width: =720
            X: =327
            Y: =231
            ZIndex: =4

    Dropdown1_2 As dropdown:
        BorderColor: =App.Theme.Colors.Darker40
        BorderStyle: =BorderStyle.None
        BorderThickness: =0
        ChevronBackground: =RGBA(237, 237, 237, 1)
        ChevronDisabledBackground: =RGBA(237, 237, 237, 1)
        ChevronDisabledFill: =RGBA(237, 237, 237, 1)
        ChevronFill: =App.Theme.Colors.PrimaryForeground
        ChevronHoverBackground: =RGBA(237, 237, 237, 1)
        ChevronHoverFill: =RGBA(237, 237, 237, 1)
        Default: ="SO báo giá"
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Fill: =RGBA(237, 237, 237, 1)
        Font: =App.Theme.Font
        FontWeight: =FontWeight.Bold
        HoverBorderColor: =RGBA(237, 237, 237, 1)
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =
        Items: =Screen_Admin
        OnChange: |-
            =Navigate(Dropdown1_2.Selected.Value,ScreenTransition.CoverRight);
            Reset(Dropdown1_2)
        PressedColor: =App.Theme.Colors.PrimaryForeground
        PressedFill: =
        SelectionColor: =App.Theme.Colors.PrimaryForeground
        SelectionFill: =RGBA(180, 214, 250, 1)
        Size: =16
        Width: =250
        X: =1108
        Y: =30
        ZIndex: =56

    dp_nhapthucong_theochietkhau_SOBG As dropdown:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderThickness: =1
        ChevronBackground: =RGBA(0, 0, 0, 0)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =RGBA(255, 255, 255, 1)
        Color: =RGBA(77, 77, 77, 1)
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Font: =Font.Arial
        Height: =30
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        Items: =var_choice_nhapthucong_theochietkhau
        OnChange: =Reset(txt_Gia);
        PressedColor: =RGBA(255, 255, 255, 1)
        PressedFill: =App.Theme.Colors.Darker30
        Reset: =reset_control
        SelectionFill: =App.Theme.Colors.Primary
        Size: =10
        Visible: =If(Checkbox_duyetgia_SOBG.Value,true,false)
        Width: =150
        X: =932
        Y: =160
        ZIndex: =57

    dp_theochietkhau_SOBG As dropdown:
        BorderColor: =RGBA(202, 202, 202, 1)
        BorderThickness: =1
        ChevronBackground: =RGBA(0, 0, 0, 0)
        ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
        ChevronDisabledFill: =RGBA(244, 244, 244, 1)
        ChevronFill: =RGBA(4, 161, 179, 1)
        ChevronHoverBackground: =App.Theme.Colors.Darker10
        ChevronHoverFill: =RGBA(255, 255, 255, 1)
        Color: =RGBA(77, 77, 77, 1)
        DisabledBorderColor: =RGBA(166, 166, 166, 1)
        DisabledColor: =RGBA(166, 166, 166, 1)
        DisabledFill: =RGBA(244, 244, 244, 1)
        Font: =Font.Arial
        Height: =30
        HoverColor: =RGBA(0, 0, 0, 1)
        HoverFill: =App.Theme.Colors.Lighter70
        Items: =var_choice_theochietkhau
        OnChange: =
        PressedColor: =RGBA(255, 255, 255, 1)
        PressedFill: =App.Theme.Colors.Darker30
        Reset: =reset_control
        SelectionFill: =App.Theme.Colors.Primary
        Size: =10
        Visible: =If(dp_nhapthucong_theochietkhau_SOBG.Selected.Value ="Theo chiết khấu", true,false)
        Width: =70
        X: =858
        Y: =160
        ZIndex: =58

    loai_don_SOBG As Text:
        AutoHeight: =false
        BorderColor: =
        DisplayMode: =DisplayMode.Edit
        Fill: =
        FontColor: =
        Height: =33
        Text: =dp_MaDH_SOBG.Selected.VAT
        Visible: =false
        Width: =102
        X: =333
        Y: =157
        ZIndex: =60

    Group2 As group:
        Height: =5
        Width: =5
        X: =40
        Y: =40
        ZIndex: =60

        lbl_Thanh_tien_SOBG As label:
            Align: =Align.Right
            BorderColor: =RGBA(219, 219, 219, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =RGBA(241, 244, 249, 1)
            Font: =App.Theme.Font
            Height: =35
            Size: =11
            Text: |
                =
                Text(Value(txt_So_luong_SOBG.Text) * (Value(lbl_GiaDaGiam_SOBG.Text)),"#,###")
            Width: =100
            X: =864
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =7

        lbl_GTGT_SOBG As label:
            Align: =Align.Right
            BorderColor: =RGBA(219, 219, 219, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =RGBA(241, 244, 249, 1)
            Font: =App.Theme.Font
            Height: =35
            Size: =11
            Text: |-
                =If(
                    dp_VAT_SOBG.Selected.Value = 0,
                    "0",
                    Text(
                        Value(lbl_Thanh_tien_SOBG.Text) * (dp_VAT_SOBG.Selected.Value / 100),
                        "#,###"
                    )
                )
            Width: =100
            X: =1071
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =8

        lbl_Tong_tien_SOBG As label:
            Align: =Align.Right
            BorderColor: =RGBA(219, 219, 219, 1)
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Fill: =RGBA(241, 244, 249, 1)
            Font: =App.Theme.Font
            Height: =35
            Size: =11
            Text: |-
                =Text(lbl_Thanh_tien_SOBG.Text + lbl_GTGT_SOBG.Text, "#,###")
            Width: =100
            X: =1205
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =9

        lbl_vat_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            PaddingLeft: =0
            Size: =11
            Text: ="VAT (%)"
            Width: =80
            X: =972
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =10

        lbl_gtgt_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            PaddingLeft: =0
            Size: =11
            Text: ="GTGT"
            Width: =96
            X: =1071
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =11

        lbl_tongtien_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            PaddingLeft: =0
            Size: =11
            Text: ="Tổng tiền"
            Width: =96
            X: =1205
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =12

        lbl_ngaygiao_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =25
            PaddingLeft: =0
            Size: =11
            Text: ="Ngày giao"
            Visible: =If(var_Nganh_nghe = "Shop",true, false)
            Width: =96
            X: =10
            Y: =225
            ZIndex: =13

        lbl_leadtimeSP_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =35
            Size: =12
            Text: |-
                ="Leadtime sp: " & cb_san_pham_SOBG.Selected.'Lead time' &" ngày"
            Visible: =!IsBlank(cb_san_pham_SOBG.Selected.'Mã sản phẩm')
            Width: =172
            X: =11
            Y: =cb_san_pham_SOBG.Y + cb_san_pham_SOBG.Height
            ZIndex: =14

        lbl_tonkhobomua_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =20
            Size: =9
            Text: |
                =If(
                
                    IsBlank(Var_ton_kho_lythuyet_inventory_vitrikho) And loai_don_SOBG.Text ="Không VAT" And !IsBlank(cb_san_pham_SOBG.Selected)  ,
                
                    "Inventory không có tồn kho",
                
                    If(
                
                        loai_don_SOBG.Text ="Không VAT"
                            && dp_ViTriKho_SOBG.Selected.'Tên kho' = Var_ton_kho_lythuyet_inventory_vitrikho.'Tên kho',
                
                            
                
                        "Tồn kho (inventory): " & Coalesce(Var_ton_kho_lythuyet_inventory, 0) 
                
                            & " " & cb_san_pham_SOBG.Selected.'Đơn vị chuẩn text' ,
                
                        "Tồn kho (bỏ mua): " & Coalesce(Var_ton_kho_lythuyet_bomua, 0) 
                
                            & " " & cb_san_pham_SOBG.Selected.'Đơn vị chuẩn text'
                
                    )
                
                )
            Visible: =!IsBlank(dp_Don_vi_SOBG.SelectedText)
            Width: =232
            X: =179
            Y: =160
            ZIndex: =15

        lbl_sltheokho_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =20
            Size: =9
            Text: |-
                ="SL theo kho: " & Text(txt_So_luong_SOBG.Text * dp_Don_vi_SOBG.Selected.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)', "#,###.##") &" "& cb_san_pham_SOBG.Selected.'Đơn vị chuẩn text'
            Visible: =!IsBlank(txt_So_luong_SOBG.Text)
            Width: =190
            X: =415
            Y: =161
            ZIndex: =16

        lbl_GiaDaGiam_SOBG As label:
            Align: =Align.Right
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(0, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =35
            PaddingLeft: =0
            Size: =12
            Text: |-
                =With(
                    {
                        Gia: If(
                            dp_nhapthucong_theochietkhau_SOBG.Selected.Value = "Theo chiết khấu",
                            gia_theochietkhau,
                            Value(txt_Gia_SOBG.Text)
                        )
                    },
                    Text(
                        If(
                            dp_MaDH_SOBG.Selected.'Loại hóa đơn' ='Loại hóa đơn (SO báo giá)'.'Hộ kinh doanh' And dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Không VAT',
                        // Nếu có xuất hóa đơn và không VAT → áp thêm 1.5%
                            If(
                                var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ And Gia > 0,
                                (Gia - Value_Promotion - Value_Promtion_Muakem) * 1.015,
                                (Gia * (1 - (Value_Promotion + Value_Promtion_Muakem) / 100)) * 1.015
                            ),
                        // Nếu không khớp điều kiện trên → không cộng VAT
                            If(
                                var_selected_Promotion.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ And Gia > 0,
                                Gia - Value_Promotion - Value_Promtion_Muakem,
                                Gia * (1 - (Value_Promotion + Value_Promtion_Muakem) / 100)
                            )
                        ),
                        "#,###"
                    )
                )
            Visible: =!IsBlank(var_selected_Promotion) Or dp_nhapthucong_theochietkhau_SOBG.Selected.Value ="Theo chiết khấu"
            Width: =100
            X: =744
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =17

        lbl_giadagiam_SOBG As label:
            Align: =Align.Center
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =30
            Size: =12
            Text: ="Giá đã giảm"
            Visible: =!IsBlank(var_selected_Promotion) Or dp_nhapthucong_theochietkhau_SOBG.Selected.Value ="Theo chiết khấu"
            Width: =97
            X: =744
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =18

        lbl_thanhtien_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            PaddingLeft: =0
            Size: =11
            Text: ="Thành tiền"
            Width: =90
            X: =868
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =19

        lbl_sanpham_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: |-
                =If(
                    Value(Substitute(Trim(cb_san_pham_SOBG.Selected.GTGT), "%", "")) > 0,
                    "Sản phẩm Có VAT",
                    "Sản phẩm không VAT"
                )
            Width: =186
            X: =10
            Y: =90
            ZIndex: =20

        lbl_donvi_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: ="Đơn vị"
            Width: =90
            X: =345
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =21

        lbl_soluong_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: ="Số lượng"
            Width: =96
            X: =dp_Don_vi_SOBG.X + dp_Don_vi_SOBG.Width + 10
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =22

        lbl_gia_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(77, 77, 77, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =Font.Arial
            Height: =30
            Size: =11
            Text: ="Giá " & dp_nhom_gia_SOBG.Selected.'Nhóm đối tượng text'
            Width: =162
            X: =614
            Y: =lbl_sanpham_SOBG.Y
            ZIndex: =23

        cb_san_pham_SOBG As combobox:
            BorderColor: =RGBA(202, 202, 202, 1)
            ChevronBackground: =RGBA(0, 0, 0, 0)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayFields: =["crdfd_name"]
            DisplayMode: =If(IsBlank(dp_MaDH_SOBG.SelectedItems), DisplayMode.Disabled, DisplayMode.Edit)
            Font: =Font.Arial
            Height: =35
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            InputTextPlaceholder: ="Sản phẩm"
            Items: =List_Product
            OnChange: =Reset(dp_VAT_SOBG);
            PressedColor: =RGBA(255, 255, 255, 1)
            PressedFill: =App.Theme.Colors.Darker30
            Reset: =true
            SearchFields: =["crdfd_name"]
            SearchItems: =Search(List_Product,cb_san_pham_SOBG.SearchText,'Tên sản phẩm')
            SelectionFill: =App.Theme.Colors.Primary
            SelectMultiple: =false
            Size: =12
            Width: =320
            X: =11
            Y: =lbl_sanpham_SOBG.Y + lbl_sanpham_SOBG.Height
            ZIndex: =24

        dp_Don_vi_SOBG As dropdown:
            BorderColor: =RGBA(202, 202, 202, 1)
            BorderThickness: =1
            ChevronBackground: =RGBA(0, 0, 0, 0)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayMode: =If(IsBlank(dp_MaDH_SOBG.SelectedItems), DisplayMode.Disabled, DisplayMode.Edit)
            Font: =Font.Arial
            Height: =35
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            Items: |-
                =Filter(
                    'Unit conversions',
                    Status = 'Status (Unit conversions)'.Active,
                    'Mã SP' = cb_san_pham_SOBG.Selected.'Mã sản phẩm'
                )
            OnChange: =
            PressedColor: =RGBA(255, 255, 255, 1)
            PressedFill: =App.Theme.Colors.Darker30
            Reset: =true
            SelectionFill: =App.Theme.Colors.Primary
            Size: =12
            Width: =150
            X: =345
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =25

        dp_VAT_SOBG As dropdown:
            BorderColor: =RGBA(116, 116, 116, 1)
            BorderThickness: =0
            ChevronBackground: =RGBA(0, 0, 0, 0)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(128, 128, 128, 1)
            Default: |-
                =If(
                    var_selected_VAT_SO = VAT_choice.'Có VAT' And var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá đã bao gồm VAT( VAT hỗ trợ)',
                    Switch(
                        var_selected_SP.GTGT,
                        'GTGT (products)'.'10%',
                        10,
                        'GTGT (products)'.'8%',
                        8,
                        'GTGT (products)'.'5%',
                        5,
                        'GTGT (products)'.'0%',
                        0
                    ),
                    If(
                        var_selected_VAT_SO = VAT_choice.'Có VAT',
                        dp_nhom_gia_SOBG.Selected.GTGT * 100,
                        0
                    )
                )
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayMode: |-
                =If(
                    dp_MaDH_SOBG.Selected.VAT = VAT_choice.'Có VAT',
                    DisplayMode.Edit,
                    DisplayMode.Disabled
                )
            Font: =Font.Arial
            Height: =35
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            Items: |-
                =Sort(
                    If(
                        var_selected_VAT_SO = VAT_choice.'Có VAT' And var_selected_SP.'Bản chất giá phát ra' = 'Bản chất giá phát ra (products)'.'Giá đã bao gồm VAT( VAT hỗ trợ)',
                        Switch(
                            var_selected_SP.GTGT,
                            'GTGT (products)'.'10%',
                            [10],
                            'GTGT (products)'.'8%',
                            [8],
                            'GTGT (products)'.'5%',
                            [5],
                            'GTGT (products)'.'0%',
                            [0]
                        ),
                        If(
                            var_selected_VAT_SO = VAT_choice.'Có VAT',
                            [
                                10,
                                8,
                                0
                            ],
                            [0]
                        )
                    ),
                    Value,
                    SortOrder.Descending
                )
            PressedColor: =RGBA(255, 255, 255, 1)
            PressedFill: =App.Theme.Colors.Darker30
            Reset: =true
            SelectionFill: =App.Theme.Colors.Primary
            Size: =12
            Width: =80
            X: =972
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =26

        txt_So_luong_SOBG As text:
            Align: =Align.Right
            BorderColor: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            Default: =If(CountRows(var_duyetgiasup) > 0 And Checkbox_duyetgiasup_SOBG.Value, First(var_duyetgiasup).'Số lượng đáp ứng', 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(0, 0, 0, 0)
            DisplayMode: |-
                =If(
                    IsBlank(dp_Don_vi_SOBG.Selected.ID),
                    DisplayMode.Disabled,
                    CountRows(var_duyetgiasup_SOBG) > 0 And Checkbox_duyetgiasup_SOBG.Value,
                    DisplayMode.Disabled,
                    DisplayMode.Edit
                )
            FocusedBorderThickness: =4
            Font: =App.Theme.Font
            Format: =TextFormat.Number
            Height: =35
            HoverBorderColor: =RGBA(186, 202, 226, 1)
            HoverColor: =RGBA(77, 77, 77, 1)
            HoverFill: =RGBA(0, 0, 0, 0)
            OnChange: |-
                =//UpdateContext({so_luong: txt_So_luong.Text})
            PressedColor: =
            PressedFill: =
            Size: =11
            Width: =100
            X: =lbl_soluong_SOBG.X
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =27

        txt_Gia_SOBG As text:
            Align: =Align.Right
            BorderColor: =RGBA(219, 219, 219, 1)
            Color: =RGBA(77, 77, 77, 1)
            Default: |-
                =Text(gia_duyet_SOBG, "#,###")
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(0, 0, 0, 0)
            DisplayMode: =If(Checkbox_duyetgia_SOBG.Value,DisplayMode.Edit,DisplayMode.View) 
            FocusedBorderThickness: =4
            Font: =App.Theme.Font
            Format: =TextFormat.Number
            Height: =35
            HoverBorderColor: =RGBA(186, 202, 226, 1)
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =RGBA(0, 0, 0, 0)
            OnChange: |-
                =UpdateContext({so_luong: txt_Gia_SOBG.Text})
            PressedFill: =
            Size: =11
            Width: =100
            X: =lbl_gia_SOBG.X
            Y: =cb_san_pham_SOBG.Y
            ZIndex: =28

        dp_ngay_giao_SOBG As datepicker:
            BorderColor: =RGBA(237, 237, 237, 1)
            BorderThickness: =1
            CalendarHeaderFill: =App.Theme.Colors.Primary
            Color: =RGBA(0, 0, 0, 1)
            DefaultDate: |-
                =If(
                    !IsBlank(cb_listPromotion_SOBG.Selected) 
                    && !IsBlank(cb_listPromotion_SOBG.Selected.cr1bb_leadtimepromotion)
                    && (IsBlank(cb_listPromotion_SOBG.Selected.cr1bb_phanloaichuongtrinh) 
                        || cb_listPromotion_SOBG.Selected.cr1bb_phanloaichuongtrinh = 'Phân loại promotion'.Hãng 
                        || cb_listPromotion_SOBG.Selected.cr1bb_phanloaichuongtrinh = 'Phân loại promotion'.Hãng),
                    DateAdd(
                        Now(),
                        Value(cb_listPromotion_SOBG.Selected.cr1bb_leadtimepromotion) * 12,
                        TimeUnit.Hours
                    ),
                    ngay_giao
                )
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            Font: =App.Theme.Font
            Format: ="dd/mm/yyyy"
            Height: =25
            HoverDateFill: =App.Theme.Colors.Lighter70
            IconBackground: =App.Theme.Colors.Primary
            OnChange: |-
                =If(
                    DateValue(dp_ngay_giao_SOBG.SelectedDate) < DateValue(ngay_giao_SOBG),
                    Notify("Ngày giao dự kiến không hợp lệ!!!", NotificationType.Warning, 1000);
                    Reset(dp_ngay_giao_SOBG)
                );
            PaddingBottom: =0
            PaddingLeft: =5
            SelectedDateFill: =App.Theme.Colors.Primary
            Size: =11
            Visible: =If(var_Nganh_nghe = "Shop", true, false)
            Width: =118
            X: =92
            Y: =225
            ZIndex: =29

        lbl_thongtinchieckhau_SOBG As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =RGBA(255, 0, 0, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =38
            OnSelect: |-
                =//UpdateContext({closePromotion:false})
            Size: =10.5
            Text: |-
                ="Giảm: " & If(
                    cb_listPromotion_SOBG.Selected.VND_Percent = 'VNĐ/% (Promotion)'.VNĐ,
                    Text(
                        Value_Promotion,
                        "#,###"
                    ) & " + " & Value_Promtion_Muakem,
                    Text(Value_Promotion) & "%" & " + " & Value_Promtion_Muakem & "%"
                )
            Visible: =!IsBlank(cb_san_pham_SOBG.SelectedItems) And !IsBlank(txt_Gia_SOBG.Text) And !IsBlank(Value_Promotion)
            Width: =200
            X: =966
            Y: =157
            ZIndex: =30

        Checkbox_duyetgiasup_SOBG As checkbox:
            BorderColor: =RGBA(237, 237, 237, 1)
            CheckboxBorderColor: =RGBA(4, 161, 179, 1)
            CheckboxSize: =25
            CheckmarkFill: =App.Theme.Colors.Primary
            Color: =RGBA(77, 77, 77, 1)
            Font: =App.Theme.Font
            Height: =35
            HoverColor: =App.Theme.Colors.Darker30
            OnSelect: |-
                =If(
                    CountRows(var_duyetgiasup_SOBG) = 0,
                    Reset(Checkbox_duyetgiasup_SOBG);
                    Notify(
                        "Không tìm ra dòng nào đã duyệt của " & cb_khach_hang_SOBG.Selected.'Customer name' & " và sp " & cb_san_pham_SOBG.Selected.'Tên sản phẩm',
                        NotificationType.Error,
                        8080
                    )
                )
            OnUncheck: |-
                =Reset(txt_Gia_SOBG);
                Reset(drd_duyet_gia_SOBG)
            Size: =11
            Text: ="Duyệt giá SUP"
            Width: =132
            X: =1226
            Y: =155
            ZIndex: =31

        Checkbox_duyetgia_SOBG As checkbox:
            BorderColor: =RGBA(237, 237, 237, 1)
            CheckboxBorderColor: =RGBA(4, 161, 179, 1)
            CheckboxSize: =25
            CheckmarkFill: =App.Theme.Colors.Primary
            Color: =RGBA(77, 77, 77, 1)
            Font: =App.Theme.Font
            Height: =35
            HoverColor: =App.Theme.Colors.Darker30
            OnCheck: =
            OnSelect: =Reset(dp_nhapthucong_theochietkhau_SOBG)
            OnUncheck: |-
                =Reset(txt_Gia_SOBG);
                Reset(drd_duyet_gia_SOBG)
            Size: =11
            Text: ="Duyệt giá"
            Width: =111
            X: =1112
            Y: =155
            ZIndex: =47

        dp_nhom_gia_SOBG As dropdown:
            BorderColor: =RGBA(202, 202, 202, 1)
            BorderThickness: =1
            ChevronBackground: =RGBA(0, 0, 0, 0)
            ChevronDisabledBackground: =RGBA(166, 166, 166, 1)
            ChevronDisabledFill: =RGBA(244, 244, 244, 1)
            ChevronFill: =RGBA(4, 161, 179, 1)
            ChevronHoverBackground: =App.Theme.Colors.Darker10
            ChevronHoverFill: =RGBA(255, 255, 255, 1)
            Color: =RGBA(77, 77, 77, 1)
            DisabledBorderColor: =RGBA(166, 166, 166, 1)
            DisabledColor: =RGBA(166, 166, 166, 1)
            DisabledFill: =RGBA(244, 244, 244, 1)
            DisplayMode: =If(IsBlank(dp_MaDH_SOBG.Selected), DisplayMode.Disabled, DisplayMode.Edit)
            Font: =Font.Arial
            Height: =35
            HoverColor: =RGBA(0, 0, 0, 1)
            HoverFill: =App.Theme.Colors.Lighter70
            Items: =var_list_gia_nhom
            OnChange: =
            PressedColor: =RGBA(255, 255, 255, 1)
            PressedFill: =App.Theme.Colors.Darker30
            Reset: =reset_control
            SelectionFill: =App.Theme.Colors.Primary
            Size: =12
            Tooltip: |-
                ="Giá nhóm: " & dp_nhom_gia_SOBG.Selected.'Nhóm đối tượng text'
            Visible: |-
                =If(
                    (Checkbox_duyetgiasup_SOBG.Value And CountRows(var_duyetgiasup_SOBG) > 0),
                    false,
                    !Checkbox_duyetgia_SOBG.Value,
                    true,
                    false
                )
            Width: =124
            X: =615
            Y: =120
            ZIndex: =52

        lbl_tonkhobomua_SOBG_1 As label:
            BorderColor: =App.Theme.Colors.Darker40
            Color: =If(var_ton_kho_lythuyet_KT < var_input_soluong * var_selected_donvi.'Giá trị chuyển đổi (Chuyển đổi/chuẩn)',RGBA(255, 0, 0, 1),RGBA(0, 0, 0, 1))
            DisabledColor: =RGBA(166, 166, 166, 1)
            Font: =App.Theme.Font
            Height: =20
            Size: =9
            Text: |-
                ="Tồn LT kế toán: " & Coalesce(var_ton_kho_lythuyet_KT,
                    0
                ) & " " & cb_san_pham_SOBG.Selected.'Đơn vị chuẩn text'
            Visible: =!IsBlank(dp_Don_vi_SOBG.SelectedText) And !IsBlank(var_ton_kho_lythuyet_KT)
            Width: =232
            X: =179
            Y: =181
            ZIndex: =59

